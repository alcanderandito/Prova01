<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Super Fabio bros - Edizione Definitiva</title>
    <style>
        body { margin: 0; padding: 0; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; -webkit-text-size-adjust: 100%; background-color: #1a1a1a; font-family: 'Arial Black', Gadget, sans-serif; color: white; overflow: hidden; -webkit-tap-highlight-color: transparent;}
        #gameWrapper { display: flex; flex-direction: column; align-items: center; width: 100%; }
        #gameContainer { position: relative; box-shadow: 0 0 30px rgba(0,0,0,0.8); background-color: #000; margin-bottom: 8px; image-rendering: -webkit-optimize-contrast; image-rendering: crisp-edges; }
        canvas { display: block; background-color: #70c5ce; image-rendering: -webkit-optimize-contrast; image-rendering: crisp-edges;}
        #uiLayer { position: absolute; top: 8px; left: 8px; right: 8px; display: none; justify-content: space-between; font-size: clamp(16px, 3vw, 20px); color: white; text-shadow: 2px 2px 3px #000000; pointer-events: none; z-index: 5; }
        #powerUpTimerDisplay { position: absolute; top: clamp(35px, 6vw, 45px); left: 50%; transform: translateX(-50%); font-size: clamp(14px, 2.5vw, 18px); color: #FFEB3B; text-shadow: 1px 1px 2px #000; display: none; z-index: 5; background-color: rgba(0,0,0,0.3); padding: 3px 8px; border-radius: 5px;}
        #touchControlsContainer { display: none; justify-content: space-around; align-items: center; width: 100%; max-width: 480px; padding: 5px 0; user-select: none; gap: 5px; }
        .touchButton { padding: 10px; font-size: 28px; color: white; background-color: rgba(60, 60, 60, 0.85); border: 1px solid rgba(220, 220, 220, 0.5); border-radius: 12px; cursor: pointer; flex-basis: 60px; flex-grow: 0; text-align: center; box-shadow: 0px 3px 5px rgba(0,0,0,0.5); transition: background-color 0.05s ease, transform 0.05s ease;}
        .touchButton:active { background-color: rgba(90, 90, 90, 0.95); transform: scale(0.95); }
        #shootTouchButton { background-color: rgba(255, 69, 0, 0.8); display: none; }
        #shootTouchButton:active { background-color: rgba(220, 50, 0, 0.9); }
        #homeButton { margin-top: 12px; padding: 9px 18px; font-size: 15px; color: white; background-color: #007bff; border: none; border-radius: 6px; text-decoration: none; cursor: pointer; }
        #homeButton:hover { background-color: #0056b3; }
        #titleScreenContainer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10; pointer-events: none; }
        #titleScreenContainer button#startButton { padding: 18px 38px; font-size: clamp(20px, 4vw, 26px); color: white; background: linear-gradient(145deg, #f57c00, #e65100); border: none; border-radius: 15px; cursor: pointer; box-shadow: 0px 7px 14px rgba(0,0,0,0.35); text-transform: uppercase; font-weight: bold; letter-spacing: 2px; pointer-events: all; transition: transform 0.1s ease, box-shadow 0.1s ease; }
        #titleScreenContainer button#startButton:hover { transform: translateY(-2px) scale(1.03); box-shadow: 0px 9px 18px rgba(0,0,0,0.4); }
        #titleScreenContainer button#startButton:active { transform: translateY(1px) scale(0.97); box-shadow: 0px 5px 10px rgba(0,0,0,0.3); }
        .gameMessage { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.88); color: white; text-align: center; z-index: 20; box-sizing: border-box; padding: 20px; backdrop-filter: blur(3px); }
        .gameMessage h1 { font-size: clamp(28px, 5.5vw, 50px); margin-bottom: 20px; text-shadow: 3px 3px 7px #000; }
        .gameMessage p { font-size: clamp(16px, 3.3vw, 24px); margin-bottom: 30px; text-shadow: 2px 2px 5px #000; }
        .gameMessage button { padding: clamp(12px, 2.5vw, 18px) clamp(25px, 5vw, 38px); font-size: clamp(16px, 3vw, 22px); color: white; background-color: #4CAF50; border: none; border-radius: 10px; cursor: pointer; box-shadow: 0px 5px 10px rgba(0,0,0,0.3); }
        .gameMessage button:hover { background-color: #45a049; }
    </style>
</head>
<body>
    <div id="gameWrapper">
        <div id="gameContainer">
            <canvas id="gameCanvas"></canvas>
            <div id="uiLayer"> <div id="livesDisplay">Vite: 5</div> <div id="scoreDisplay">Score: 0</div> </div>
            <div id="powerUpTimerDisplay">Chef Furioso: 0s</div>
            <div id="titleScreenContainer"> <button id="startButton">Inizia Gioco</button> </div>
        </div>
        <div id="touchControlsContainer"> <div class="touchButton" id="leftTouchButton">‚óÄÔ∏è</div> <div class="touchButton" id="rightTouchButton">‚ñ∂Ô∏è</div> <div class="touchButton" id="jumpTouchButton">üîº</div> <div class="touchButton" id="shootTouchButton">üî•</div> </div>
    </div>
    <a id="homeButton" href="index.html">Torna alla Home</a>

    <div id="gameOverScreen" class="gameMessage"><h1>GAME OVER</h1> <p id="finalScore"></p> <button id="restartButton">Riprova</button> </div>
    <div id="winScreen" class="gameMessage"> <h1>HAI VINTO!</h1> <p>Complimenti, Super Fabio!</p> <p id="winFinalScore"></p> <button id="playAgainButton">Gioca Ancora</button> </div>
    <div id="levelCompleteScreen" class="gameMessage"> <h1>LIVELLO COMPLETATO!</h1> <p>Pronto per il prossimo?</p> <p id="levelCompleteScore"></p> <button id="nextLevelButton">Prossimo Livello</button> </div>

    <script>
        // ----- SETUP -----
        const canvas = document.getElementById('gameCanvas'); const ctx = canvas.getContext('2d');
        const gameContainer = document.getElementById('gameContainer'); const uiLayer = document.getElementById('uiLayer');
        const livesDisplay = document.getElementById('livesDisplay'); const scoreDisplay = document.getElementById('scoreDisplay');
        const powerUpTimerDisplay = document.getElementById('powerUpTimerDisplay');
        const titleScreenContainer = document.getElementById('titleScreenContainer'); const startButton = document.getElementById('startButton');
        const gameOverScreen = document.getElementById('gameOverScreen'); const finalScoreDisplay = document.getElementById('finalScore');
        const restartButton = document.getElementById('restartButton'); const winScreen = document.getElementById('winScreen');
        const winFinalScoreDisplay = document.getElementById('winFinalScore'); const playAgainButton = document.getElementById('playAgainButton');
        const levelCompleteScreen = document.getElementById('levelCompleteScreen'); const levelCompleteScoreDisplay = document.getElementById('levelCompleteScore');
        const nextLevelButton = document.getElementById('nextLevelButton');
        const touchControlsContainer = document.getElementById('touchControlsContainer'); const leftTouchButton = document.getElementById('leftTouchButton');
        const rightTouchButton = document.getElementById('rightTouchButton'); const jumpTouchButton = document.getElementById('jumpTouchButton');
        const shootTouchButton = document.getElementById('shootTouchButton');

        let player, enemies = [], collectibles = [], platforms = [], camera, projectiles = [];
        let score = 0, lives = 5, currentLevelIndex = 0;
        const NUM_LEVELS = 5, INITIAL_LIVES = 5, SCORE_PER_LEVEL = 1000;
        let gameState = 'LOADING';

        const images = { player: new Image(), enemy: new Image(), mainScreen: new Image() };
        let imagesLoaded = 0; const TOTAL_IMAGES = 3;
        images.player.src = 'fabiogame2.PNG'; images.enemy.src = 'mostro.PNG'; images.mainScreen.src = 'fabiogame.PNG';
        images.player.onload = images.enemy.onload = images.mainScreen.onload = () => {
            imagesLoaded++;
            if (imagesLoaded === TOTAL_IMAGES) {
                console.log("Tutte le immagini sono caricate.");
                if (document.readyState === 'complete') { resizeCanvas(); showTitleScreen(); } else { window.addEventListener('load', () => { resizeCanvas(); showTitleScreen(); });}
            }
        };
        
        const GRAVITY = 0.65, PLAYER_SPEED = 4.2, PLAYER_JUMP_FORCE = 14, TILE_SIZE = 40;
        let BASE_ENEMY_SPEED = 0.65; 

        let chefFuriosoActive = false, chefFuriosoTimer = 0;
        const CHEF_FURIOSO_DURATION = 12; 
        let monstersKilledForPowerUp = 0;
        const MONSTERS_FOR_POWERUP_THRESHOLD = 6; 
        const PROJECTILE_SPEED = 9;

        const levelBackgroundColors = ['#70c5ce', '#e6994b', '#5d943c', '#8c8c8c', '#4b0082'];
        const backgroundDrawers = [
            (ctx, width, height) => { ctx.fillStyle = '#70c5ce'; ctx.fillRect(0,0,width,height); ctx.fillStyle = 'rgba(255,255,255,0.8)'; [[100,100,50], [300,150,70], [550,80,60], [750,120,40]].forEach(c => { ctx.beginPath(); ctx.arc(c[0],c[1],c[2],0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(c[0]+c[2]*0.6,c[1]+c[2]*0.1,c[2]*0.7,0,Math.PI*2); ctx.fill();}); },
            (ctx, width, height) => { ctx.fillStyle = '#e6994b'; ctx.fillRect(0,0,width,height); ctx.fillStyle = '#d48842'; ctx.beginPath(); ctx.moveTo(0, height*0.85); ctx.quadraticCurveTo(width*0.25, height*0.75, width*0.5, height*0.88); ctx.quadraticCurveTo(width*0.75, height, width, height*0.8); ctx.lineTo(width, height); ctx.lineTo(0, height); ctx.closePath(); ctx.fill(); ctx.fillStyle = '#b06d31'; ctx.beginPath(); ctx.moveTo(0,height*0.95); ctx.quadraticCurveTo(width*0.3,height*0.9, width*0.6, height*0.96); ctx.lineTo(width,height); ctx.lineTo(0,height); ctx.closePath();ctx.fill();},
            (ctx, width, height) => { ctx.fillStyle = '#5d943c'; ctx.fillRect(0,0,width,height); ctx.fillStyle = '#4a752f'; [[100,height-150,30,120,'#386423'], [250,height-120,20,100,'#386423'], [450,height-180,35,150,'#386423'], [650,height-140,25,110,'#386423']].forEach(t => { ctx.fillStyle=t[4]; ctx.fillRect(t[0]-t[2]/2, t[1], t[2], t[3]); ctx.fillStyle = '#4CAF50'; ctx.beginPath(); ctx.ellipse(t[0],t[1],t[2]*2.2, t[2]*1.8,0,0,Math.PI*2); ctx.fill();}); },
            (ctx, width, height) => { ctx.fillStyle = '#2c3e50'; ctx.fillRect(0,0,width,height); [[50,200,60,250,'#34495e'], [150,150,70,300,'#3f576e'], [280,250,50,200,'#34495e'], [400,180,80,270,'#3f576e'], [550,220,60,230,'#34495e'], [670,190,70,260,'#3f576e']].forEach(b => { ctx.fillStyle=b[4]; ctx.fillRect(b[0],height-b[3],b[2],b[3]); ctx.fillStyle = 'rgba(241, 196, 15,0.6)'; for(let y=height-b[3]+10; y<height-10; y+=20){ for(let x=b[0]+5; x<b[0]+b[2]-5; x+=15){ if(Math.random()>0.5) ctx.fillRect(x,y,4,7);}} }); },
            (ctx, width, height) => { ctx.fillStyle = '#4b0082'; ctx.fillRect(0,0,width,height); ctx.fillStyle = '#300050'; [[100,height-280,80,280], [width-180,height-300,90,300]].forEach(t => { ctx.fillRect(t[0],t[1],t[2],t[3]); ctx.beginPath(); ctx.moveTo(t[0]-15, t[1]); ctx.lineTo(t[0]+t[2]/2, t[1]-60); ctx.lineTo(t[0]+t[2]+15, t[1]); ctx.closePath(); ctx.fill(); }); ctx.fillStyle='rgba(255,0,0,0.1)'; for(let i=0; i<5; i++){ ctx.beginPath(); ctx.arc(Math.random()*width, Math.random()*height*0.5, Math.random()*30+10,0,Math.PI*2); ctx.fill();}}
        ];

        const GAME_WIDTH = 800, GAME_HEIGHT = 450;
        let currentScaleFactor = 1; 
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        let titleScreenElements = { fabio: null, enemies: [], collectibles: [] };
        let titleFabioDir = 1, titleFabioJumpTimer = 0, titleFabioBaseY;

        // ----- CLASSI DI GIOCO -----
        class Camera { constructor(x,y,w,h,ww,wh){this.x=x;this.y=y;this.width=w;this.height=h;this.worldWidth=ww;this.worldHeight=wh;} follow(t){let tx=t.x+t.width/2-this.width/2;this.x=Math.max(0,Math.min(tx,this.worldWidth-this.width));this.y=0;} apply(c){c.translate(-this.x,-this.y);} reset(c){c.translate(this.x,this.y);}}
        class Platform { constructor(x,y,w,h,c='#654321'){this.x=x;this.y=y;this.width=w;this.height=h;this.color=c;} draw(c){c.fillStyle=this.color;c.fillRect(this.x,this.y,this.width,this.height);}}
        class Player { constructor(x,y){this.x=x;this.y=y;this.width=TILE_SIZE*0.85;this.height=TILE_SIZE*1.5;this.dx=0;this.dy=0;this.onGround=false;this.image=images.player;this.facingRight=true;} jump(){if(this.onGround){this.dy=-PLAYER_JUMP_FORCE;this.onGround=false;}} move(d){this.dx=d*PLAYER_SPEED;if(d!==0)this.facingRight=d>0;} update(pfs){this.x+=this.dx;pfs.forEach(p=>{if(this.collidesWith(p)){if(this.dx>0&&this.x+this.width>p.x&&this.x<p.x){this.x=p.x-this.width;this.dx=0;}else if(this.dx<0&&this.x<p.x+p.width&&this.x+this.width>p.x+p.width){this.x=p.x+p.width;this.dx=0;}}});this.dy+=GRAVITY;this.y+=this.dy;this.onGround=false;pfs.forEach(p=>{if(this.collidesWith(p)){if(this.dy>0&&this.y+this.height>p.y&&(this.y+this.height-this.dy)<=p.y+1){this.y=p.y-this.height;this.dy=0;this.onGround=true;}else if(this.dy<0&&this.y<p.y+p.height&&(this.y-this.dy)>=p.y+p.height-1){this.y=p.y+p.height;this.dy=0;}}});if(this.x<0)this.x=0;if(this.y>GAME_HEIGHT+this.height*1.5)loseLife();} draw(c){if(!this.image.complete||this.image.naturalHeight===0){c.fillStyle='blue';c.fillRect(this.x,this.y,this.width,this.height);return;}c.save();if(!this.facingRight){c.translate(this.x+this.width,this.y);c.scale(-1,1);c.drawImage(this.image,0,0,this.width,this.height);}else{c.drawImage(this.image,this.x,this.y,this.width,this.height);}c.restore();} collidesWith(o){return this.x<o.x+o.width&&this.x+this.width>o.x&&this.y<o.y+o.height&&this.y+this.height>o.y;} shoot(){if(chefFuriosoActive){const pX=this.facingRight?this.x+this.width:this.x-20;const pY=this.y+this.height/2-5;const pDir=this.facingRight?1:-1;projectiles.push(new Projectile(pX,pY,pDir));}}}
        class Enemy { constructor(x,y,isBoss=false,speedMult=1,initialHp=1){this.x=x;this.y=y;this.isBoss=isBoss;this.width=isBoss?TILE_SIZE*2.8:TILE_SIZE*1.1;this.height=isBoss?TILE_SIZE*2.8:TILE_SIZE*1.1;this.image=images.enemy;this.dx=-(BASE_ENEMY_SPEED*speedMult)*(Math.random()*0.4+0.8);this.active=true;this.bossHealth=initialHp;this.initialBossHp=initialHp;this.speedMultiplier=speedMult;} update(pfs){if(!this.active)return;this.x+=this.dx;let hitWall=false;pfs.forEach(p=>{if(this.y+this.height>p.y&&this.y<p.y+p.height){if((this.dx<0&&this.x<=p.x+p.width&&this.x+this.width>=p.x+p.width&&this.x>p.x)||(this.dx>0&&this.x+this.width>=p.x&&this.x<=p.x&&this.x+this.width<p.x+p.width)){hitWall=true;}}});if(hitWall||this.x<0-this.width*2||this.x+this.width>camera.worldWidth+this.width*2){this.dx*=-1;this.x+=this.dx*0.1;}} draw(c){if(!this.active)return;if(!this.image.complete||this.image.naturalHeight===0){c.fillStyle='red';c.fillRect(this.x,this.y,this.width,this.height);return;}c.drawImage(this.image,this.x,this.y,this.width,this.height);if(this.isBoss&&this.bossHealth>0){c.fillStyle='red';c.font='bold 16px Arial';c.textAlign='center';c.fillText(`BOSS HP:${Math.ceil(this.bossHealth)}/${this.initialBossHp}`,this.x+this.width/2,this.y-10);}} takeDamage(amount=1){this.bossHealth-=this.isBoss?amount/5:amount; if(this.bossHealth<=0){this.active=false;score+=this.isBoss?1500:150;updateScoreDisplay();if(!this.isBoss)monstersKilledForPowerUp++;}else if(this.isBoss)this.dx*=1.02;} stomp(){this.bossHealth-=1;if(this.bossHealth<=0){this.active=false;score+=this.isBoss?1500:150;updateScoreDisplay();if(!this.isBoss)monstersKilledForPowerUp++;}else{this.y-=15;if(this.isBoss)this.dx*=1.05;}}}
        class Collectible { constructor(x,y,type='salad'){this.x=x;this.y=y;this.active=true;this.type=type;this.angle=Math.random()*Math.PI*2; this.bobSpeed=0.05+Math.random()*0.05; this.bobAmount=3+Math.random()*3; this.baseY = y; if(type==='salad'){this.width=TILE_SIZE*0.7;this.height=TILE_SIZE*0.7;this.text='ü•ó';this.value=50;}else if(type==='powerup'){this.width=TILE_SIZE*1.1;this.height=TILE_SIZE*1.1;this.text='üç≤';this.value=200;}} update(dt){this.angle+=this.bobSpeed*(dt/16.66||1); this.y = this.baseY + Math.sin(this.angle)*this.bobAmount;} draw(c){if(!this.active)return;c.font=`${this.height*1.1}px Arial`;c.textAlign="center";c.fillText(this.text,this.x+this.width/2,this.y+this.height*0.85);} onCollect(){if(this.type==='powerup'){chefFuriosoActive=true;chefFuriosoTimer=CHEF_FURIOSO_DURATION;powerUpTimerDisplay.style.display='block';if(isMobile&¬§tLevelIndex>=2)shootTouchButton.style.display='inline-block';}score+=this.value;updateScoreDisplay();this.active=false;}}
        class Projectile { constructor(x,y,dir){this.x=x;this.y=y;this.width=22;this.height=12;this.dx=dir*PROJECTILE_SPEED;this.text=dir>0?'üç¥':'üî™';this.active=true;} update(){this.x+=this.dx;if(this.x>camera.x+GAME_WIDTH+50||this.x<camera.x-this.width-50)this.active=false;} draw(c){c.font=`bold ${this.height*2.2}px Arial`;c.fillStyle='#e0e0e0';c.textBaseline='middle';c.textAlign='center';c.fillText(this.text,this.x+this.width/2,this.y+this.height/2);} collidesWith(o){return this.x<o.x+o.width&&this.x+this.width>o.x&&this.y<o.y+o.height&&this.y+this.height>o.y;}}

        // ----- DEFINIZIONE LIVELLI -----
        const baseLevelConfigs = [
            { playerStart:{x:50,y:GAME_HEIGHT-TILE_SIZE*2.5}, worldWidth:2000, enemyBaseSpeed:0.6, platforms:[{x:0,y:GAME_HEIGHT-TILE_SIZE*1.5,width:400,height:TILE_SIZE*1.5},{x:450,y:GAME_HEIGHT-TILE_SIZE*3,width:150,height:TILE_SIZE},{x:650,y:GAME_HEIGHT-TILE_SIZE*4,width:150,height:TILE_SIZE},{x:900,y:GAME_HEIGHT-TILE_SIZE*2,width:200,height:TILE_SIZE},{x:1200,y:GAME_HEIGHT-TILE_SIZE*1.5,width:800,height:TILE_SIZE*1.5}], enemies:[{x:300,y:GAME_HEIGHT-TILE_SIZE*2.5-TILE_SIZE*1.1},{x:700,y:GAME_HEIGHT-TILE_SIZE*5-TILE_SIZE*1.1}], collectibles:[{x:100,y:GAME_HEIGHT-TILE_SIZE*3},{x:550,y:GAME_HEIGHT-TILE_SIZE*4.5}]},
            { playerStart:{x:50,y:GAME_HEIGHT-TILE_SIZE*4.5}, worldWidth:2500, enemyBaseSpeed:0.7, platforms:[{x:0,y:GAME_HEIGHT-TILE_SIZE*1.5,width:200,height:TILE_SIZE*1.5},{x:250,y:GAME_HEIGHT-TILE_SIZE*3,width:100,height:TILE_SIZE},{x:400,y:GAME_HEIGHT-TILE_SIZE*4.5,width:100,height:TILE_SIZE},{x:550,y:GAME_HEIGHT-TILE_SIZE*2.5,width:100,height:TILE_SIZE},{x:700,y:GAME_HEIGHT-TILE_SIZE*1.5,width:300,height:TILE_SIZE*1.5},{x:1100,y:GAME_HEIGHT-TILE_SIZE*3.5,width:150,height:TILE_SIZE},{x:1300,y:GAME_HEIGHT-TILE_SIZE*5,width:150,height:TILE_SIZE},{x:1600,y:GAME_HEIGHT-TILE_SIZE*1.5,width:900,height:TILE_SIZE*1.5}], enemies:[{x:150,y:GAME_HEIGHT-TILE_SIZE*2.5-TILE_SIZE*1.1},{x:450,y:GAME_HEIGHT-TILE_SIZE*5.5-TILE_SIZE*1.1},{x:800,y:GAME_HEIGHT-TILE_SIZE*2.5-TILE_SIZE*1.1}], collectibles:[{x:300,y:GAME_HEIGHT-TILE_SIZE*4},{x:600,y:GAME_HEIGHT-TILE_SIZE*6},{x:1100,y:GAME_HEIGHT-TILE_SIZE*4.5}]},
            { playerStart:{x:50,y:GAME_HEIGHT-TILE_SIZE*2.5}, worldWidth:2800, enemyBaseSpeed:0.8, platforms:[{x:0,y:GAME_HEIGHT-TILE_SIZE*1.5,width:100,height:TILE_SIZE*1.5},{x:150,y:GAME_HEIGHT-TILE_SIZE*3,width:100,height:TILE_SIZE},{x:300,y:GAME_HEIGHT-TILE_SIZE*4,width:100,height:TILE_SIZE},{x:450,y:GAME_HEIGHT-TILE_SIZE*5,width:100,height:TILE_SIZE},{x:600,y:GAME_HEIGHT-TILE_SIZE*3.5,width:100,height:TILE_SIZE},{x:750,y:GAME_HEIGHT-TILE_SIZE*1.5,width:100,height:TILE_SIZE*1.5},{x:900,y:GAME_HEIGHT-TILE_SIZE*4.5,width:200,height:TILE_SIZE},{x:1200,y:GAME_HEIGHT-TILE_SIZE*2.5,width:150,height:TILE_SIZE},{x:1500,y:GAME_HEIGHT-TILE_SIZE*1.5,width:1300,height:TILE_SIZE*1.5}], enemies:[{x:350,y:GAME_HEIGHT-TILE_SIZE*5-TILE_SIZE*1.1},{x:650,y:GAME_HEIGHT-TILE_SIZE*4.5-TILE_SIZE*1.1},{x:1000,y:GAME_HEIGHT-TILE_SIZE*5.5-TILE_SIZE*1.1}], collectibles:[{x:70,y:GAME_HEIGHT-TILE_SIZE*3},{x:500,y:GAME_HEIGHT-TILE_SIZE*6},{x:950,y:GAME_HEIGHT-TILE_SIZE*5.5}]},
            { playerStart:{x:50,y:GAME_HEIGHT-TILE_SIZE*5.5}, worldWidth:3000, enemyBaseSpeed:0.9, platforms:[{x:0,y:GAME_HEIGHT-TILE_SIZE*1.5,width:500,height:TILE_SIZE*1.5},{x:300,y:GAME_HEIGHT-TILE_SIZE*4,width:50,height:TILE_SIZE},{x:400,y:GAME_HEIGHT-TILE_SIZE*5,width:50,height:TILE_SIZE},{x:500,y:GAME_HEIGHT-TILE_SIZE*6,width:50,height:TILE_SIZE},{x:650,y:GAME_HEIGHT-TILE_SIZE*2.5,width:150,height:TILE_SIZE},{x:850,y:GAME_HEIGHT-TILE_SIZE*5.5,width:200,height:TILE_SIZE},{x:1100,y:GAME_HEIGHT-TILE_SIZE*4,width:150,height:TILE_SIZE},{x:1400,y:GAME_HEIGHT-TILE_SIZE*1.5,width:1600,height:TILE_SIZE*1.5}], enemies:[{x:400,y:GAME_HEIGHT-TILE_SIZE*7-TILE_SIZE*1.1},{x:700,y:GAME_HEIGHT-TILE_SIZE*3.5-TILE_SIZE*1.1},{x:950,y:GAME_HEIGHT-TILE_SIZE*6.5-TILE_SIZE*1.1},{x:1200,y:GAME_HEIGHT-TILE_SIZE*5-TILE_SIZE*1.1}], collectibles:[{x:100,y:GAME_HEIGHT-TILE_SIZE*3},{x:450,y:GAME_HEIGHT-TILE_SIZE*7},{x:700,y:GAME_HEIGHT-TILE_SIZE*4.5},{x:1150,y:GAME_HEIGHT-TILE_SIZE*5.5}]},
            { playerStart:{x:50,y:GAME_HEIGHT-TILE_SIZE*2.5}, worldWidth:1600, enemyBaseSpeed:0.7, platforms:[{x:0,y:GAME_HEIGHT-TILE_SIZE*1.5,width:650,height:TILE_SIZE*1.5},{x:750,y:GAME_HEIGHT-TILE_SIZE*4,width:100,height:TILE_SIZE},{x:900,y:GAME_HEIGHT-TILE_SIZE*1.5,width:700,height:TILE_SIZE*1.5}], enemies:[{x:400,y:GAME_HEIGHT-TILE_SIZE*2.5-TILE_SIZE*1.1},{x:1100,y:GAME_HEIGHT-TILE_SIZE*1.5-TILE_SIZE*2.8,isBoss:true,initialHp:10,speedMult:0.6}], collectibles:[{x:200,y:GAME_HEIGHT-TILE_SIZE*3},{x:800,y:GAME_HEIGHT-TILE_SIZE*5}]}
        ];
        const levelData = [];
        function populateLevel(baseConfig, levelIdx) {
            let config = JSON.parse(JSON.stringify(baseConfig));
            config.enemySpeedMultiplier = 1 + (levelIdx * 0.05); // Incremento pi√π graduale
            let targetCollectibles = 8 + levelIdx * 4; // Meno collezionabili, ma pi√π significativi
            let targetEnemies = 2 + levelIdx * 2;

            while(config.collectibles.length < targetCollectibles && config.platforms.length > 0){
                let pIndex = Math.floor(Math.random() * config.platforms.length);
                let p = config.platforms[pIndex];
                let cX = p.x + TILE_SIZE*0.5 + Math.random() * (p.width - TILE_SIZE);
                let cY = p.y - TILE_SIZE * (1.2 + Math.random()*1.5);
                if(cY > TILE_SIZE) config.collectibles.push({ x: cX, y: cY, type:'salad' });
            }
            let nonBossEnemies = config.enemies.filter(e=>!e.isBoss).length;
            while(nonBossEnemies < targetEnemies && config.platforms.length > 1){
                let pIndex = Math.floor(Math.random() * config.platforms.length);
                let p = config.platforms[pIndex];
                if (p.width > TILE_SIZE * 3) { 
                     let eX = p.x + TILE_SIZE*1.5 + Math.random() * (p.width - TILE_SIZE*3);
                     let eY = p.y - TILE_SIZE*1.1; // Altezza nemico
                     config.enemies.push({ x: eX, y: eY, isBoss:false, speedMult: config.enemySpeedMultiplier, initialHp:1 });
                     nonBossEnemies++;
                }
            }
            return config;
        }
        for(let i=0; i<NUM_LEVELS; i++){ levelData.push(populateLevel(baseLevelConfigs[i] || baseLevelConfigs[0], i)); }


        // ----- FUNZIONI DI GIOCO -----
        function resizeCanvas() {
            canvas.width = GAME_WIDTH; canvas.height = GAME_HEIGHT;
            const availableWidth = window.innerWidth; 
            let availableHeight = window.innerHeight; 
            if (isMobile) availableHeight -= (touchControlsContainer.offsetHeight + 15); 
            availableHeight -= (document.getElementById('homeButton')?.offsetHeight + 15);

            const scaleX = availableWidth / GAME_WIDTH; const scaleY = availableHeight / GAME_HEIGHT;
            currentScaleFactor = Math.min(scaleX, scaleY); 

            gameContainer.style.width = GAME_WIDTH * currentScaleFactor + 'px';
            gameContainer.style.height = GAME_HEIGHT * currentScaleFactor + 'px';

            if (isMobile) {
                touchControlsContainer.style.display = 'flex';
                touchControlsContainer.style.width = Math.min(GAME_WIDTH * currentScaleFactor, availableWidth * 0.98) + 'px';
            } else {
                touchControlsContainer.style.display = 'none';
            }
             if(gameState === 'TITLE_SCREEN' && titleScreenElements.fabio) { titleFabioBaseY = GAME_HEIGHT - TILE_SIZE * 1.5 - titleScreenElements.fabio.height; titleScreenElements.fabio.y = titleFabioBaseY;}
            if ((gameState !== 'LOADING' && imagesLoaded === TOTAL_IMAGES) || gameState === 'LOADING' && imagesLoaded === TOTAL_IMAGES) { // Se le immagini sono cariche o se era loading e sono appena state caricate
                 if(document.readyState === 'complete') draw(); // Ridisegna solo se il DOM √® pronto e le immagini sono caricate
            }
        }
        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('orientationchange', resizeCanvas);


        function initTitleScreenElements() {
            const platformHeightDemo = TILE_SIZE * 1.5;
            titleFabioBaseY = GAME_HEIGHT - platformHeightDemo - (TILE_SIZE*1.5); // Altezza Player
            titleScreenElements.fabio = new Player(GAME_WIDTH * 0.45, titleFabioBaseY);
            titleScreenElements.fabio.onGround = true;

            titleScreenElements.enemies = [
                new Enemy(GAME_WIDTH * 0.2, GAME_HEIGHT - platformHeightDemo - TILE_SIZE*1.1, false, 0.5, 1),
                new Enemy(GAME_WIDTH * 0.8, GAME_HEIGHT - platformHeightDemo - TILE_SIZE*1.1, false, 0.5, 1)
            ];
            titleScreenElements.enemies.forEach(e => { e.dx = (Math.random() < 0.5 ? 1 : -1) * BASE_ENEMY_SPEED * e.speedMultiplier * 0.8; });

            titleScreenElements.collectibles = [
                new Collectible(GAME_WIDTH * 0.35, GAME_HEIGHT - platformHeightDemo - TILE_SIZE * 3),
                new Collectible(GAME_WIDTH * 0.65, GAME_HEIGHT - platformHeightDemo - TILE_SIZE * 3.5)
            ];
            titleFabioJumpTimer = 2 + Math.random()*2; 
        }

        function loadLevel(levelIdx) {
            const currentLevelConfig = levelData[levelIdx];
            BASE_ENEMY_SPEED = currentLevelConfig.enemyBaseSpeed || (0.65 + levelIdx * 0.1);
            player = new Player(currentLevelConfig.playerStart.x, currentLevelConfig.playerStart.y);
            platforms = currentLevelConfig.platforms.map(p => new Platform(p.x, p.y, p.width, p.height, p.color));
            enemies = currentLevelConfig.enemies.map(e => new Enemy(e.x, e.y, e.isBoss, e.isBoss ? e.speedMult : (e.speedMult || currentLevelConfig.enemySpeedMultiplier), e.initialHp || (e.isBoss ? 10 : 1) ));
            collectibles = currentLevelConfig.collectibles.map(c => new Collectible(c.x, c.y, c.type || 'salad'));
            projectiles = [];
            monstersKilledForPowerUp = 0; chefFuriosoActive = false; chefFuriosoTimer = 0;
            powerUpTimerDisplay.style.display = 'none';
            if(isMobile) shootTouchButton.style.display = 'none';
            camera = new Camera(0, 0, GAME_WIDTH, GAME_HEIGHT, currentLevelConfig.worldWidth, GAME_HEIGHT);
            titleScreenElements.fabio = null; 
        }
        
        function resetGame(startLevelZero = true) {
            score = 0; lives = INITIAL_LIVES;
            currentLevelIndex = startLevelZero ? 0 : currentLevelIndex;
            updateScoreDisplay(); updateLivesDisplay();
            loadLevel(currentLevelIndex);
            gameState = 'PLAYING';
            hideAllScreens(); titleScreenContainer.style.display = 'none';
            uiLayer.style.display = 'flex';
            powerUpTimerDisplay.style.display = 'none';
            if(isMobile) shootTouchButton.style.display = 'none';
        }
        function startGameFlow() { if(gameState === 'TITLE_SCREEN' || gameState === 'GAME_OVER' || gameState === 'WIN') resetGame(true); }
        function showTitleScreen() { gameState = 'TITLE_SCREEN'; if (!titleScreenElements.fabio || titleScreenElements.fabio.y === undefined ) initTitleScreenElements(); hideAllScreens(); titleScreenContainer.style.display = 'flex'; uiLayer.style.display = 'none'; powerUpTimerDisplay.style.display = 'none'; if(isMobile) shootTouchButton.style.display = 'none'; resizeCanvas(); /* Forza resize e draw */ }
        function hideAllScreens() {gameOverScreen.style.display='none';winScreen.style.display='none';levelCompleteScreen.style.display='none';}
        function loseLife() { lives--; updateLivesDisplay(); if(lives<=0)setGameOver(); else {const ld=(levelData[currentLevelIndex] || levelData[0]).playerStart; player.x=ld.x;player.y=ld.y;player.dx=0;player.dy=0;camera.x=0;}}
        function completeLevel() { gameState = 'LEVEL_COMPLETE'; levelCompleteScoreDisplay.textContent = `Score: ${score}`; levelCompleteScreen.style.backgroundImage = images.mainScreen.complete ? `url('${images.mainScreen.src}')` : ''; showScreen(levelCompleteScreen); uiLayer.style.display='none'; if(isMobile) shootTouchButton.style.display='none'; }
        function proceedToNextLevel() { currentLevelIndex++; if(currentLevelIndex>=NUM_LEVELS)setGameWin(); else {loadLevel(currentLevelIndex);gameState='PLAYING';hideAllScreens();uiLayer.style.display='flex';} }
        function setGameOver() { gameState = 'GAME_OVER'; finalScoreDisplay.textContent = `Score Finale: ${score}`; gameOverScreen.style.backgroundImage = images.mainScreen.complete ? `url('${images.mainScreen.src}')` : ''; showScreen(gameOverScreen); uiLayer.style.display='none'; if(isMobile) shootTouchButton.style.display='none';}
        function setGameWin() { gameState = 'WIN'; winFinalScoreDisplay.textContent = `Score Finale: ${score}`; winScreen.style.backgroundImage = images.mainScreen.complete ? `url('${images.mainScreen.src}')` : ''; showScreen(winScreen); uiLayer.style.display='none'; if(isMobile) shootTouchButton.style.display='none';}
        function showScreen(screenEl){hideAllScreens(); screenEl.style.display='flex';}
        function updateScoreDisplay() { scoreDisplay.textContent = `Score: ${score}`; }
        function updateLivesDisplay() { livesDisplay.textContent = `Vite: ${lives}`; }

        // ----- INPUT HANDLING -----
        const keys = { left: false, right: false, jump: false, shoot: false };
        window.addEventListener('keydown', (e) => { if(gameState!=='PLAYING')return; if(e.code==='ArrowLeft'||e.code==='KeyA')keys.left=true; if(e.code==='ArrowRight'||e.code==='KeyD')keys.right=true; if(e.code==='Space'||e.code==='ArrowUp'||e.code==='KeyW')keys.jump=true; if(e.code==='KeyX'||e.code==='ControlLeft')keys.shoot=true; });
        window.addEventListener('keyup', (e) => { if(gameState!=='PLAYING')return; if(e.code==='ArrowLeft'||e.code==='KeyA')keys.left=false; if(e.code==='ArrowRight'||e.code==='KeyD')keys.right=false; if(e.code==='Space'||e.code==='ArrowUp'||e.code==='KeyW')keys.jump=false; if(e.code==='KeyX'||e.code==='ControlLeft')keys.shoot=false; });
        function setupTouchButtonEvents() { ['touchstart','mousedown'].forEach(evt=>{ leftTouchButton.addEventListener(evt,e=>{if(gameState!=='PLAYING')return;e.preventDefault();keys.left=true;}); rightTouchButton.addEventListener(evt,e=>{if(gameState!=='PLAYING')return;e.preventDefault();keys.right=true;}); jumpTouchButton.addEventListener(evt,e=>{if(gameState!=='PLAYING')return;e.preventDefault();keys.jump=true;}); shootTouchButton.addEventListener(evt,e=>{if(gameState!=='PLAYING')return;e.preventDefault();keys.shoot=true;}); }); ['touchend','mouseup','mouseleave'].forEach(evt=>{ leftTouchButton.addEventListener(evt,e=>{e.preventDefault();keys.left=false;}); rightTouchButton.addEventListener(evt,e=>{e.preventDefault();keys.right=false;}); jumpTouchButton.addEventListener(evt,e=>{e.preventDefault();keys.jump=false;}); shootTouchButton.addEventListener(evt,e=>{e.preventDefault();keys.shoot=false;}); });}
        if (isMobile) setupTouchButtonEvents();
        function handleInput() { if(!player) return; let md=0; if(keys.left)md=-1; else if(keys.right)md=1; player.move(md); if(keys.jump&&player.onGround)player.jump(); if(keys.shoot&&chefFuriosoActive){player.shoot();keys.shoot=false;}}

        // ----- UPDATE & DRAW -----
        function updateTitleScreen(deltaTime) {
            const dtRatio = deltaTime / 16.66 || 1; 
            if (titleScreenElements.fabio) {
                titleScreenElements.fabio.x += titleFabioDir * PLAYER_SPEED * 0.25 * dtRatio;
                if (titleScreenElements.fabio.x < TILE_SIZE*1.5 || titleScreenElements.fabio.x > GAME_WIDTH - TILE_SIZE*2.5) { titleFabioDir *= -1; titleScreenElements.fabio.facingRight = titleFabioDir > 0; }
                titleFabioJumpTimer -= deltaTime/1000;
                if (titleFabioJumpTimer <= 0 && titleScreenElements.fabio.onGround) { titleScreenElements.fabio.dy = -PLAYER_JUMP_FORCE * 0.55; titleScreenElements.fabio.onGround = false; titleFabioJumpTimer = 1.5 + Math.random()*2.5; }
                titleScreenElements.fabio.dy += GRAVITY * 0.7 * dtRatio; titleScreenElements.fabio.y += titleScreenElements.fabio.dy * dtRatio;
                if(titleScreenElements.fabio.y >= titleFabioBaseY){ titleScreenElements.fabio.y = titleFabioBaseY; titleScreenElements.fabio.dy = 0; titleScreenElements.fabio.onGround = true;}
            }
            titleScreenElements.enemies.forEach(enemy => { enemy.x += enemy.dx * 0.35 * dtRatio; if (enemy.x < TILE_SIZE*0.5 || enemy.x > GAME_WIDTH - TILE_SIZE*1.5) enemy.dx *= -1; });
            titleScreenElements.collectibles.forEach(c=>c.update(deltaTime));
        }

        function update(deltaTime) {
            if (gameState === 'PLAYING') {
                 if(!player) return; // Safety check
                 handleInput(); player.update(platforms);
                 projectiles.forEach(p => p.update()); projectiles = projectiles.filter(p => p.active);
                 enemies.forEach(enemy => { if(enemy.active) enemy.update(platforms); });
                 collectibles.forEach(c=>c.update(deltaTime));
                 camera.follow(player);
                 projectiles.forEach(proj => { enemies.forEach(enemy => { if (proj.active && enemy.active && proj.collidesWith(enemy)) { enemy.takeDamage(1); proj.active = false; }}); });
                 enemies.forEach(enemy => { if (enemy.active && player.collidesWith(enemy)) { if(player.dy>0 && (player.y+player.height-player.dy) <= enemy.y+10 && !player.onGround){enemy.stomp();player.dy=-PLAYER_JUMP_FORCE/1.7;player.onGround=false;} else if (player.y+player.height > enemy.y+TILE_SIZE*0.3 && player.y < enemy.y + enemy.height - TILE_SIZE*0.3) loseLife();}}); // Check vertical overlap for damage
                 collectibles.forEach((collectible) => { if (collectible.active && player.collidesWith(collectible)) collectible.onCollect(); });
                 collectibles = collectibles.filter(collectible => collectible.active);
                 if (chefFuriosoActive) { chefFuriosoTimer -= deltaTime/1000; powerUpTimerDisplay.textContent = `Chef Furioso: ${Math.ceil(chefFuriosoTimer)}s`; if (chefFuriosoTimer <= 0) { chefFuriosoActive = false; powerUpTimerDisplay.style.display = 'none'; if(isMobile)shootTouchButton.style.display='none';} }
                 else if(isMobile) shootTouchButton.style.display='none'; // Assicura che sia nascosto se non attivo
                 
                 if (currentLevelIndex >= 2 && monstersKilledForPowerUp >= MONSTERS_FOR_POWERUP_THRESHOLD && !collectibles.find(c=>c.type==='powerup')) { collectibles.push(new Collectible(player.x + (player.facingRight?TILE_SIZE*2:-TILE_SIZE*2), player.y - TILE_SIZE*2.5, 'powerup')); monstersKilledForPowerUp = 0; }
                 const requiredScore = (currentLevelIndex + 1) * SCORE_PER_LEVEL;
                 if (currentLevelIndex === NUM_LEVELS - 1) { const boss = enemies.find(e => e.isBoss); if (boss && !boss.active && score >= requiredScore - SCORE_PER_LEVEL*0.5) completeLevel(); } // Meno score richiesto per boss se gi√† battuto
                 else if (score >= requiredScore) completeLevel();
            } else if (gameState === 'TITLE_SCREEN') { updateTitleScreen(deltaTime); }
        }

        function drawTitleScreen() {
            if (backgroundDrawers[0] && typeof backgroundDrawers[0] === 'function') backgroundDrawers[0](ctx, GAME_WIDTH, GAME_HEIGHT); else { ctx.fillStyle = levelBackgroundColors[0] || '#70c5ce'; ctx.fillRect(0,0,GAME_WIDTH,GAME_HEIGHT); }
            ctx.fillStyle = '#543d2a'; ctx.fillRect(0, GAME_HEIGHT - TILE_SIZE * 1.5, GAME_WIDTH, TILE_SIZE * 1.5); 
            if (titleScreenElements.fabio) titleScreenElements.fabio.draw(ctx);
            titleScreenElements.enemies.forEach(e => e.draw(ctx)); titleScreenElements.collectibles.forEach(c => c.draw(ctx));
            ctx.textAlign = "center"; ctx.font = "bold 64px 'Arial Black', Gadget, sans-serif"; ctx.fillStyle = "#fff"; ctx.strokeStyle = "#e64a19"; ctx.lineWidth = 7;
            const titleText = "Super Fabio bros"; const titleX = GAME_WIDTH/2; const titleY = GAME_HEIGHT*0.25;
            ctx.strokeText(titleText, titleX, titleY); ctx.fillText(titleText, titleX, titleY);
            ctx.font = "italic 28px 'Arial Black', Gadget, sans-serif"; ctx.fillStyle = "#FFEB3B"; ctx.shadowColor = "rgba(0,0,0,0.7)"; ctx.shadowBlur = 6;
            ctx.fillText("L'Avventura pi√π Saporita!", titleX, titleY + 50); ctx.shadowBlur = 0;
        }

        function draw() {
            if (gameState === 'LOADING' && imagesLoaded < TOTAL_IMAGES) { ctx.fillStyle='black'; ctx.fillRect(0,0,GAME_WIDTH,GAME_HEIGHT); ctx.fillStyle='white';ctx.font='20px Arial';ctx.textAlign='center'; ctx.fillText('Caricamento Super Fabio...', GAME_WIDTH/2, GAME_HEIGHT/2); return; }
            if (gameState === 'TITLE_SCREEN') { drawTitleScreen(); }
            else if (gameState === 'PLAYING') {
                const bgDrawer = backgroundDrawers[currentLevelIndex];
                if (bgDrawer && typeof bgDrawer === 'function') bgDrawer(ctx, GAME_WIDTH, GAME_HEIGHT); else { ctx.fillStyle = levelBackgroundColors[currentLevelIndex] || '#333'; ctx.fillRect(0,0,GAME_WIDTH,GAME_HEIGHT); }
                ctx.save(); camera.apply(ctx);
                platforms.forEach(p => p.draw(ctx)); collectibles.forEach(c => c.draw(ctx));
                enemies.forEach(e => e.draw(ctx)); projectiles.forEach(p => p.draw(ctx));
                if(player) player.draw(ctx);
                ctx.restore();
            } else { 
                 const bgIdx = currentLevelIndex >=0 && currentLevelIndex < NUM_LEVELS ? currentLevelIndex : 0; 
                 const modalBgDrawer = backgroundDrawers[bgIdx];
                 if (modalBgDrawer && typeof modalBgDrawer === 'function') modalBgDrawer(ctx, GAME_WIDTH, GAME_HEIGHT);
                 else { ctx.fillStyle = levelBackgroundColors[bgIdx] || '#333'; ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT); }
            }
        }

        // ----- GAME LOOP -----
        let lastTime = 0;
        function gameLoop(timestamp) {
            const deltaTime = Math.max(0, Math.min((timestamp - lastTime) || 16.66, 60)); 
            lastTime = timestamp;
            if (imagesLoaded === TOTAL_IMAGES) { // Esegui logica solo se immagini cariche
                update(deltaTime); 
                draw(); 
            }
            requestAnimationFrame(gameLoop);
        }

        // ----- INIZIALIZZAZIONE -----
        startButton.addEventListener('click', startGameFlow);
        restartButton.addEventListener('click', () => { if(gameState==='GAME_OVER')resetGame(false);}); 
        playAgainButton.addEventListener('click', startGameFlow);
        nextLevelButton.addEventListener('click', proceedToNextLevel);
        
        // Chiamata iniziale a resize e avvio del loop
        // showTitleScreen √® chiamato dall'onload delle immagini o dal listener 'load' della finestra
        // per assicurare che il DOM e le immagini siano pronti.
        if (document.readyState === 'complete' && imagesLoaded === TOTAL_IMAGES) {
             resizeCanvas(); 
             showTitleScreen();
        } else if (document.readyState === 'complete' && imagesLoaded < TOTAL_IMAGES) {
             resizeCanvas(); // Prepara layout
             gameState = 'LOADING'; draw(); // Mostra caricamento
        } else { // Fallback se 'load' non scatta o immagini lente
            window.addEventListener('load', () => {
                 resizeCanvas();
                 if(imagesLoaded === TOTAL_IMAGES) showTitleScreen();
                 else { gameState = 'LOADING'; draw(); }
            });
        }
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>
