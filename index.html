<!DOCTYPE html><html lang="it"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Don¬†Alfred¬†Chat</title>
<style>
/* ========== BASE ================================================= */
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;font-family:-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
/* ========== MOBILE ONLY (0‚Äë600‚ÄØpx) =============================== */
@media (max-width:600px){
:root{/* var --vh aggiornata da JS + safe‚Äëarea */--vh:1vh;--T:env(safe-area-inset-top);--B:env(safe-area-inset-bottom);--KB:0px;}
body.lock{position:fixed;overflow:hidden;width:100%;}

/* floating WA‚Äëstyle button */
#openChat{position:fixed;top:calc(1rem + var(--T));right:1rem;width:60px;height:60px;border:none;border-radius:50%;
          background:#25d366 url("https://img.icons8.com/ios-filled/50/ffffff/chat--v1.png") center/60% no-repeat;
          box-shadow:0 4px 14px rgba(0,0,0,.25);z-index:1000;cursor:pointer;}
#openChat:active{transform:scale(.9);}

/* CHAT box full‚Äëscreen */
#chat{position:fixed;inset:0;display:none;flex-direction:column;width:100vw;
      height:calc(var(--vh)*100);background:#ece5dd;overscroll-behavior:contain;touch-action:pan-y;z-index:1100;}
#chat::before{content:"";position:absolute;inset:0;background:url("https://raw.githubusercontent.com/raj457036/whatsapp-chat-background/master/bg.png")0/540px repeat;opacity:.15;}

/* top‚Äëbar */
.top{display:flex;align-items:center;gap:10px;color:#fff;font-weight:500;font-size:16px;
     background:#075e54;padding:10px 16px;padding-top:calc(10px + var(--T));z-index:2;}
.top .name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.top button{background:none;border:none;color:#fff;font-size:26px;cursor:pointer;line-height:1;}

/* messages area */
#msgs{flex:1;overflow-y:auto;padding:10px 12px 100px 12px;display:flex;flex-direction:column;gap:6px;z-index:1;}

/* input‚Äëbar */
#bar{position:fixed;left:0;right:0;bottom:0;display:flex;align-items:center;gap:8px;
     padding:8px 8px calc(8px + var(--B));background:#f0f0f0;z-index:2;transition:transform .2s;}
#bar input{flex:1;border:none;border-radius:20px;padding:10px 12px;font-size:15px;background:#fff;}
#bar button{width:46px;height:46px;border:none;border-radius:50%;background:#25d366;display:flex;align-items:center;justify-content:center;}

/* bubbles */
.msg{max-width:80%;display:flex;flex-direction:column;font-size:14px;position:relative;}
.b{padding:6px 8px 18px;border-radius:8px;line-height:1.35;box-shadow:0 1px 1px rgba(0,0,0,.08);}
.t{position:absolute;bottom:2px;right:6px;font-size:11px;opacity:.6;}
.me .b{background:#d1f8c6;border-radius:8px 0 8px 8px;align-self:flex-end;}
.me .b::after{content:"‚úî‚úî";position:absolute;bottom:2px;right:-18px;font-size:11px;color:#34b7f1;font-weight:700;}
.you .b{background:#fff;border-radius:0 8px 8px 8px;}
}

/* ========== DESKTOP block (‚â•601‚ÄØpx) =============================== */
@media (min-width:601px){
body::before{content:'üõë¬†Solo¬†smartphone';display:flex;align-items:center;justify-content:center;height:100vh;width:100%;
            font-size:2.5rem;background:#000;color:#fff;text-align:center;}
#openChat,#chat{display:none!important;}html,body{overflow:hidden;}
}
</style>
</head><body>

<button id="openChat" aria-label="apri chat"></button>

<div id="chat">
  <div class="top"><span class="name">Don‚ÄØAlfred ü§µüèª‚Äç‚ôÇÔ∏è</span><button id="close">‚úï</button></div>
  <div id="msgs"></div>
  <form id="bar"><input id="txt" placeholder="Messaggio"><button type="submit">
     <img src="https://img.icons8.com/ios/50/ffffff/filled-sent.png" style="width:24px"></button></form>
</div>

<script>
const btnOpen=Q('#openChat'),chat=Q('#chat'),btnClose=Q('#close'),txt=Q('#txt'),bar=Q('#bar'),msgs=Q('#msgs');function Q(s){return document.querySelector(s)}
let history=[];

/* open/close */
btnOpen.onclick=_=>{document.body.classList.add('lock');chat.style.display='flex';txt.focus();}
btnClose.onclick=_=>{chat.style.display='none';document.body.classList.remove('lock')}

/* bubble helper */
function add(who,text){const d=document.createElement('div');d.className='msg '+who;
const t=new Date().toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'});
d.innerHTML=`<div class="b">${text}<span class="t">${t}</span></div>`;msgs.appendChild(d);msgs.scrollTop=msgs.scrollHeight}

/* send */
bar.addEventListener('submit',async e=>{
 e.preventDefault();const v=txt.value.trim();if(!v)return;add('me',v);history.push({role:'user',content:v});txt.value='';
 try{const r=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:v,history})});
 const {reply}=await r.json();add('you',reply);history.push({role:'assistant',content:reply});}catch{add('you','Errore di rete üò¢')}
});

/* viewport & keyboard */
(function(){
 const setVH=()=>{const h=window.visualViewport?visualViewport.height:window.innerHeight;
                  document.documentElement.style.setProperty('--vh',`${h*0.01}px`);}
 setVH();(window.visualViewport||window).addEventListener('resize',setVH);

 /* segue tastiera */
 if(window.visualViewport){
   const follow=()=>{const gap=Math.max(0,window.innerHeight-visualViewport.height-visualViewport.offsetTop);
     bar.style.transform=`translateY(-${gap}px)`;msgs.style.paddingBottom=`${100+gap}px`;}
   visualViewport.addEventListener('resize',follow);visualViewport.addEventListener('scroll',follow);follow();
 }
})();

/* blocca rubber‚Äëband su iOS dentro chat */
['touchstart','touchmove'].forEach(ev=>{
  chat.addEventListener(ev,e=>{
    if(e.touches.length>1)return;
    const atTop=msgs.scrollTop===0,atBottom=Math.ceil(msgs.scrollHeight-msgs.scrollTop)===msgs.clientHeight;
    const dir=e.touches[0].clientY-e.touches[0].screenY;
    if((atTop&&dir>0)||(atBottom&&dir<0))e.preventDefault();
  },{passive:false});
});
</script>
</body></html>
