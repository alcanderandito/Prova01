<!DOCTYPE html><html lang="it"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Don Alfred Chat</title>

<style>
*{margin:0;padding:0;box-sizing:border-box}        /* reset */
html,body{height:100%;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif}

/* ---------- SOLO MOBILE 0‑600 px ----------------------------------- */
@media (max-width:600px){
:root{--vh:1vh}                                    /* fallback per iOS <15.6 */

/* WA‑button --------------------------------------------------------- */
#btn{position:fixed;top:1rem;right:1rem;width:60px;height:60px;border:none;border-radius:50%;
     background:#25d366 url("https://img.icons8.com/ios-filled/50/ffffff/chat--v1.png") center/60% no-repeat;
     box-shadow:0 4px 14px rgba(0,0,0,.25);z-index:1000;cursor:pointer}
#btn:active{transform:scale(.9)}

/* Chat container ---------------------------------------------------- */
#box{
  position:fixed;inset:0;display:none;flex-direction:column;width:100vw;
  height:100dvh;                                   /* viewport dinamica nativa */
  height:calc(var(--vh)*100);                      /* fallback runtime */
  padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
  background:#ece5dd;overscroll-behavior:contain;touch-action:pan-y;z-index:1100
}
#box::before{content:"";position:absolute;inset:0;background:url("https://raw.githubusercontent.com/raj457036/whatsapp-chat-background/master/bg.png")0/540px repeat;opacity:.15}

/* Top‑bar ----------------------------------------------------------- */
.head{flex:0 0 auto;height:48px;background:#075e54;color:#fff;display:flex;align-items:center;
      gap:10px;padding:0 16px;font-weight:500;font-size:16px}
.head .name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.head button{background:none;border:none;color:#fff;font-size:26px;cursor:pointer}

/* Messages list ----------------------------------------------------- */
#list{flex:1 1 auto;overflow-y:auto;display:flex;flex-direction:column;gap:6px;padding:10px 12px}

/* Input‑bar --------------------------------------------------------- */
#bar{flex:0 0 auto;height:60px;display:flex;align-items:center;gap:8px;padding:0 8px;background:#f0f0f0;
     transition:transform .2s}
#bar input{flex:1;padding:10px 12px;border:none;border-radius:20px;background:#fff;font-size:15px}
#bar button{width:46px;height:46px;border:none;border-radius:50%;background:#25d366;display:flex;align-items:center;justify-content:center}

/* Bubble ------------------------------------------------------------ */
.msg{max-width:80%;display:flex;flex-direction:column;font-size:14px;position:relative}
.bub{padding:6px 8px 18px;border-radius:8px;line-height:1.35;box-shadow:0 1px 1px rgba(0,0,0,.08)}
.time{position:absolute;bottom:2px;right:6px;font-size:11px;opacity:.6}
.me  .bub{background:#d1f8c6;border-radius:8px 0 8px 8px;align-self:flex-end}
.me  .bub::after{content:"✔✔";position:absolute;bottom:2px;right:-18px;font-size:11px;color:#34b7f1;font-weight:700}
.you .bub{background:#fff;border-radius:0 8px 8px 8px}
}

/* ---------- DESKTOP BLOCCATO -------------------------------------- */
@media (min-width:601px){
body::before{content:'🛑 Solo smartphone';display:flex;align-items:center;justify-content:center;height:100vh;width:100%;
             font-size:2.5rem;background:#000;color:#fff;text-align:center}
#btn,#box{display:none!important}html,body{overflow:hidden}
}
</style>
</head><body>

<button id="btn" aria-label="Apri chat"></button>

<div id="box">
  <div class="head"><span class="name">Don Alfred 🤵🏻‍♂️</span><button id="x">✕</button></div>
  <div id="list"></div>
  <form id="bar"><input id="txt" placeholder="Messaggio"><button type="submit">
    <img src="https://img.icons8.com/ios/50/ffffff/filled-sent.png" style="width:24px"></button></form>
</div>

<script>
const $=s=>document.querySelector(s),btn=$('#btn'),box=$('#box'),x=$('#x'),txt=$('#txt'),
      list=$('#list'),bar=$('#bar');let hist=[];

/* OPEN/CLOSE -------------------------------------------------------- */
btn.onclick=_=>{box.style.display='flex';document.body.style.overflow='hidden';txt.focus()}
x.onclick  =_=>{box.style.display='none';document.body.style.overflow=''}

/* BUBBLE ------------------------------------------------------------ */
function add(who,text){
  const d=document.createElement('div');d.className='msg '+who;
  const t=new Date().toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'});
  d.innerHTML=`<div class="bub">${text}<span class="time">${t}</span></div>`;
  list.appendChild(d);list.scrollTop=list.scrollHeight;
}

/* SEND -------------------------------------------------------------- */
bar.addEventListener('submit',async e=>{
  e.preventDefault();const v=txt.value.trim();if(!v)return;
  add('me',v);hist.push({role:'user',content:v});txt.value='';
  try{
    const r=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({message:v,history:hist})});
    const {reply}=await r.json();add('you',reply);hist.push({role:'assistant',content:reply})
  }catch{add('you','Errore di rete 😢')}
});

/* VIEWPORT & KEYBOARD ---------------------------------------------- */
(function(){
  /* 1) fallback --vh per iOS <15.6 */
  const updVH=()=>{const h=window.visualViewport?visualViewport.height:innerHeight;
                   document.documentElement.style.setProperty('--vh',`${h*0.01}px`)}
  updVH();(window.visualViewport||window).addEventListener('resize',updVH);

  /* 2) tastiera: gap = innerHeight - vv.height */
  if(window.visualViewport){
    const follow=()=>{const gap=Math.max(0,innerHeight-visualViewport.height-visualViewport.offsetTop);
      bar.style.transform=`translateY(-${gap}px)`;list.style.paddingBottom=`${gap+10}px`}
    visualViewport.addEventListener('resize',follow);
    visualViewport.addEventListener('scroll',follow);follow();
  }
})();

/* BLOCCA RUBBER‑BAND ----------------------------------------------- */
['touchstart','touchmove'].forEach(ev=>{
  box.addEventListener(ev,e=>{
    if(e.touches.length>1)return;
    const atTop=list.scrollTop===0,atBottom=Math.abs(list.scrollHeight-list.scrollTop-list.clientHeight)<1,
          dir=e.touches[0].clientY-e.touches[0].screenY;
    if((atTop&&dir>0)||(atBottom&&dir<0))e.preventDefault();
  },{passive:false});
});
</script>
</body></html>
