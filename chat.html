<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <!-- mantieni viewport stabile e blocca zoom su focus -->
  <meta name="viewport"
        content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
  <title>Chat ‚Ä¢ Don Alfred</title>
  <style>
    /* RESET & BASE */
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif}

    /* SAFE-AREA & VAR DINAMICHE */
    :root{
      --safeT:env(safe-area-inset-top);
      --safeB:env(safe-area-inset-bottom);
      --safeL:env(safe-area-inset-left);
      --safeR:env(safe-area-inset-right);
      --kbInset:var(--safeB);  /* aggiornato da JS */
    }

    /* quando la tastiera √® aperta, POSIZIONA #log pi√π in alto ma NON bloccarne lo scroll */
    html.kb-open #log {
      /* tolto overflow:hidden per permettere lo scroll manuale */
      bottom: calc(var(--kbInset) + 56px) !important;
      overflow-y: auto !important;
    }

    /* HEADER: sempre in cima, z-index alto */
    header{
      position:fixed;
      top:var(--safeT); left:var(--safeL); right:var(--safeR);
      height:48px; line-height:48px;
      background:#075e54; color:#fff;
      display:flex; align-items:center; gap:12px;
      padding:0 16px; font-weight:500; font-size:18px;
      z-index:200;
    }
    header a{font-size:28px; text-decoration:none; color:inherit}
    header .title{flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    /* INPUT-BAR: sempre sopra #log, si alza con la tastiera */
    #bar{
      position:fixed;
      left:var(--safeL); right:var(--safeR);
      bottom:var(--kbInset);
      height:56px;
      background:#f0f0f0;
      display:flex; align-items:center; gap:8px;
      padding:0 8px; z-index:190;
      transition:bottom .2s;
    }
    #bar input{
      flex:1;
      border:none;
      border-radius:20px;
      padding:10px 14px;
      font-size:16px;
      background:#fff;
    }
    #bar button{
      border:none;
      width:46px; height:46px;
      border-radius:50%;
      background:#25d366;
      display:flex; align-items:center; justify-content:center;
    }

    /* AREA MESSAGGI: bottom dinamico */
    #log{
      position:fixed;
      top:calc(var(--safeT) + 48px);
      left:var(--safeL); right:var(--safeR);
      bottom:calc(var(--kbInset) + 56px);
      overflow-y:auto;
      padding:12px;
      background:#ece5dd url("https://raw.githubusercontent.com/raj457036/whatsapp-chat-background/master/bg.png")0/540px repeat;
      background-blend-mode:luminosity;
      display:flex; flex-direction:column; gap:6px;
      scroll-behavior:smooth;
      z-index:100;
    }

    /* BOLLE stile WhatsApp */
    .msg{max-width:80%;position:relative;font-size:14px;line-height:1.35}
    .bub{padding:6px 8px 18px;border-radius:8px;box-shadow:0 1px 1px #0001}
    .tim{position:absolute;bottom:2px;right:6px;font-size:11px;opacity:.6}
    .me  .bub{background:#d1f8c6;border-radius:8px 0 8px 8px;margin-left:auto}
    .me  .bub::after{content:"‚úî‚úî";position:absolute;bottom:2px;right:-18px;font-size:11px;color:#34b7f1;font-weight:700}
    .you .bub{background:#fff;border-radius:0 8px 8px 8px}

    /* NASCONDI SU DESKTOP */
    @media(min-width:601px){
      body::before{
        content:'üõë Apri da smartphone';
        display:flex;align-items:center;justify-content:center;
        height:100vh;width:100%;font-size:2.5rem;
        background:#000;color:#fff;text-align:center;
      }
      header,#log,#bar{display:none}
    }
  </style>
</head>
<body>

  <header>
    <a href="index.html">‚Äπ</a>
    <span class="title">Don Alfred ü§µüèª‚Äç‚ôÇÔ∏è</span>
  </header>

  <div id="log" role="log" aria-live="polite"></div>

  <form id="bar" autocomplete="off">
    <input id="txt" placeholder="Messaggio" enterkeyhint="send">
    <button type="submit" aria-label="Invia">
      <img src="https://img.icons8.com/ios/50/ffffff/filled-sent.png" alt="" style="width:24px">
    </button>
  </form>

  <script>
    const log = document.getElementById('log');
    const inp = document.getElementById('txt');
    const form = document.getElementById('bar');
    const vv = window.visualViewport;

    (function syncKbInset(){
      function update(){
        const safeB = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--safeB')) || 0;
        const vh = vv ? vv.height : window.innerHeight;
        const vo = vv ? vv.offsetTop : 0;
        const overlap = window.innerHeight - vh - vo;
        const inset = overlap > 0 ? overlap + safeB : safeB;
        document.documentElement.style.setProperty('--kbInset', inset + 'px');
        document.documentElement.classList.toggle('kb-open', overlap > 0);
      }
      update();

      if(vv){
        vv.addEventListener('resize', update);
        vv.addEventListener('scroll', update);
      }
      // NUOVE RIGHE PER SUPPORTARE PI√ô BROWSER
      window.addEventListener('resize', update);
      window.addEventListener('orientationchange', update);
      inp.addEventListener('focus', update);
      inp.addEventListener('blur', update);
    })();

    function scrollBottom(){
      if (!document.documentElement.classList.contains('kb-open')) {
        log.scrollTop = log.scrollHeight;
      }
    }

    function bubble(who, text){
      const time = new Date().toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'});
      log.insertAdjacentHTML('beforeend',
        `<div class="msg ${who}">
           <div class="bub">${text}<span class="tim">${time}</span></div>
         </div>`);
      scrollBottom();
    }

    let history = [];
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const t = inp.value.trim();
      if(!t) return;
      bubble('me', t);
      history.push({role:'user',content:t});
      inp.value = '';
      try {
        const res = await fetch('/api/chat', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({message:t,history})
        });
        const { reply } = await res.json();
        bubble('you', reply);
        history.push({role:'assistant',content:reply});
      } catch {
        bubble('you','Errore di rete üò¢');
      }
    });
  </script>
</body>
</html>
