<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Super Fabio bros Deluxe Final</title>
    <style>
        body {
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #2c2c2c;
            font-family: 'Arial', sans-serif;
            color: white;
            overflow: hidden;
        }
        #gameWrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #gameContainer {
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.6);
            /* transform-origin: center center; // Scala dal centro se usi transform scale */
            background-color: #000; /* Sfondo di fallback per il container */
            margin-bottom: 10px;
        }
        canvas {
            display: block;
            background-color: #70c5ce; /* Colore di fallback iniziale, sovrascritto da JS */
        }
        #uiLayer {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: none; /* Nascosto di default, mostrato da JS in PLAYING */
            justify-content: space-between;
            font-size: 20px;
            color: white;
            text-shadow: 1px 1px 3px #000000;
            pointer-events: none;
            z-index: 5;
        }
        #powerUpTimerDisplay {
            position: absolute;
            top: 40px; /* Sotto vite/score */
            left: 50%;
            transform: translateX(-50%);
            font-size: 18px;
            color: #FFD700; /* Oro */
            text-shadow: 1px 1px 2px #000;
            display: none; /* Mostrato da JS quando il power-up √® attivo */
            z-index: 5;
        }
        #touchControlsContainer {
            display: none; /* Mostrato solo su mobile da JS */
            justify-content: space-between;
            align-items: center;
            width: 100%; 
            max-width: 500px; 
            padding: 10px 0;
            user-select: none;
            gap: 10px; /* Spazio tra i pulsanti */
        }
        .touchButton {
            padding: 15px; /* Padding uniforme per renderli pi√π quadrati */
            font-size: 28px; /* Icone pi√π grandi e chiare */
            color: white;
            background-color: rgba(80, 80, 80, 0.75);
            border: 1px solid rgba(255, 255, 255, 0.35);
            border-radius: 12px; /* Pi√π arrotondati */
            cursor: pointer;
            flex-grow: 1; /* Distribuisce lo spazio equamente */
            text-align: center;
            box-shadow: 0px 3px 5px rgba(0,0,0,0.35);
            transition: background-color 0.1s ease;
        }
        .touchButton:active {
            background-color: rgba(120, 120, 120, 0.85);
        }
        #shootTouchButton {
             background-color: rgba(255, 69, 0, 0.7); /* Arancione */
             display: none;
        }
        #shootTouchButton:active {
            background-color: rgba(220, 50, 0, 0.8);
        }

        #homeButton {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            text-decoration: none;
            cursor: pointer;
        }
        #homeButton:hover {
            background-color: #0056b3;
        }

        /* Schermata Iniziale (solo per il pulsante ora) */
        #titleScreenContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none; /* Mostrato da JS */
            flex-direction: column;
            align-items: center;
            justify-content: center; 
            z-index: 10; 
            pointer-events: none; 
        }
        #titleScreenContainer button { /* Pulsante "Inizia Gioco" */
            padding: 18px 35px;
            font-size: 22px;
            color: white;
            background: linear-gradient(145deg, #e64a19, #f57c00); /* Gradiente arancione/rosso */
            border: none;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0px 5px 10px rgba(0,0,0,0.4);
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 1.5px;
            pointer-events: all;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }
        #titleScreenContainer button:hover {
            transform: translateY(-2px);
            box-shadow: 0px 7px 12px rgba(0,0,0,0.5);
        }
        #titleScreenContainer button:active {
            transform: translateY(1px);
            box-shadow: 0px 3px 7px rgba(0,0,0,0.4);
        }

        .gameMessage { /* Game Over, Win, Level Complete */
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            background-color: rgba(0,0,0,0.8); /* Sfondo pi√π scuro per messaggi modali */
            color: white; text-align: center; z-index: 20; /* Sopra la title screen */
            box-sizing: border-box; padding: 20px;
        }
         .gameMessage h1 { font-size: clamp(30px, 5vw, 48px); margin-bottom: 20px; text-shadow: 2px 2px 6px #000; }
        .gameMessage p { font-size: clamp(18px, 3vw, 24px); margin-bottom: 30px; text-shadow: 1px 1px 4px #000; }
        .gameMessage button { /* Pulsanti Riprova, Gioca Ancora, Prossimo Livello */
            padding: clamp(14px, 2.2vw, 20px) clamp(28px, 4.5vw, 40px);
            font-size: clamp(18px, 2.8vw, 22px);
            color: white; background-color: #4CAF50; /* Verde per azioni positive */
            border: none; border-radius: 10px; cursor: pointer;
            box-shadow: 0px 4px 8px rgba(0,0,0,0.35);
            transition: background-color 0.2s ease;
        }
        .gameMessage button:hover { background-color: #45a049; }
    </style>
</head>
<body>
    <div id="gameWrapper">
        <div id="gameContainer">
            <canvas id="gameCanvas"></canvas>
            <div id="uiLayer">
                <div id="livesDisplay">Vite: 5</div>
                <div id="scoreDisplay">Score: 0</div>
            </div>
            <div id="powerUpTimerDisplay">Chef Furioso: 0s</div>

            <div id="titleScreenContainer">
                <button id="startButton">Inizia Gioco</button>
            </div>
        </div>

        <div id="touchControlsContainer">
            <div class="touchButton" id="leftTouchButton">‚óÄÔ∏è</div>
            <div class="touchButton" id="rightTouchButton">‚ñ∂Ô∏è</div>
            <div class="touchButton" id="jumpTouchButton">üîº</div>
            <div class="touchButton" id="shootTouchButton">üî•</div>
        </div>
    </div>

    <a id="homeButton" href="index.html">Torna alla Home</a>

    <div id="gameOverScreen" class="gameMessage">
        <h1>GAME OVER</h1> <p id="finalScore"></p> <button id="restartButton">Riprova</button>
    </div>
    <div id="winScreen" class="gameMessage">
        <h1>HAI VINTO!</h1> <p>Complimenti, Super Fabio!</p> <p id="winFinalScore"></p> <button id="playAgainButton">Gioca Ancora</button>
    </div>
    <div id="levelCompleteScreen" class="gameMessage">
        <h1>LIVELLO COMPLETATO!</h1> <p>Pronto per il prossimo?</p> <p id="levelCompleteScore"></p> <button id="nextLevelButton">Prossimo Livello</button>
    </div>

    <script>
        // ----- SETUP -----
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameContainer = document.getElementById('gameContainer'); // Per scaling futuro se necessario
        const uiLayer = document.getElementById('uiLayer');
        const livesDisplay = document.getElementById('livesDisplay');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const powerUpTimerDisplay = document.getElementById('powerUpTimerDisplay');

        const titleScreenContainer = document.getElementById('titleScreenContainer');
        const startButton = document.getElementById('startButton');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const finalScoreDisplay = document.getElementById('finalScore');
        const restartButton = document.getElementById('restartButton');
        const winScreen = document.getElementById('winScreen');
        const winFinalScoreDisplay = document.getElementById('winFinalScore');
        const playAgainButton = document.getElementById('playAgainButton');
        const levelCompleteScreen = document.getElementById('levelCompleteScreen');
        const levelCompleteScoreDisplay = document.getElementById('levelCompleteScore');
        const nextLevelButton = document.getElementById('nextLevelButton');

        const touchControlsContainer = document.getElementById('touchControlsContainer');
        const leftTouchButton = document.getElementById('leftTouchButton');
        const rightTouchButton = document.getElementById('rightTouchButton');
        const jumpTouchButton = document.getElementById('jumpTouchButton');
        const shootTouchButton = document.getElementById('shootTouchButton');

        let player, enemies, collectibles, platforms, camera, projectiles;
        let score = 0, lives = 5, currentLevelIndex = 0;
        const NUM_LEVELS = 5, INITIAL_LIVES = 5, SCORE_PER_LEVEL = 1000;
        let gameState = 'LOADING'; // LOADING, TITLE_SCREEN, PLAYING, LEVEL_COMPLETE, GAME_OVER, WIN

        const images = { player: new Image(), enemy: new Image(), mainScreen: new Image() };
        let imagesLoaded = 0; const TOTAL_IMAGES = 3;
        images.player.src = 'fabiogame2.PNG'; images.enemy.src = 'mostro.PNG'; images.mainScreen.src = 'fabiogame.PNG';
        images.player.onload = images.enemy.onload = images.mainScreen.onload = () => {
            imagesLoaded++;
            if (imagesLoaded === TOTAL_IMAGES) {
                console.log("Immagini caricate");
                resizeCanvas(); // Chiamare resize dopo caricamento per dimensioni corrette
                showTitleScreen();
            }
        };
        
        const GRAVITY = 0.6, PLAYER_SPEED = 4, PLAYER_JUMP_FORCE = 13, TILE_SIZE = 40;
        let BASE_ENEMY_SPEED = 1.0;

        let chefFuriosoActive = false, chefFuriosoTimer = 0;
        const CHEF_FURIOSO_DURATION = 15;
        let monstersKilledForPowerUp = 0;
        const MONSTERS_FOR_POWERUP_THRESHOLD = 10; // Abbassato per test pi√π facili, puoi rialzarlo
        const PROJECTILE_SPEED = 7;

        const levelBackgroundColors = ['#70c5ce', '#e6994b', '#5d943c', '#8c8c8c', '#4b0082'];
        const backgroundDrawers = [ /* ... come definito prima (cielo, deserto, foresta, citt√†, castello) ... */ ];

        const GAME_WIDTH = 800, GAME_HEIGHT = 450;
        let scaleFactor = 1; // Scala per il gameContainer
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        // Titolo Schermata Elementi
        let titleScreenElements = { fabio: null, enemies: [], collectibles: [] };
        let titleFabioDir = 1;

        // ----- CLASSI DI GIOCO (Player, Enemy, Collectible, Platform, Projectile) -----
        // (Incolla qui le definizioni delle classi come nella versione precedente, assicurandoti che
        //  Player.shoot(), Enemy.takeDamage(), Enemy.stomp(), Collectible.onCollect() siano corrette)
        class Player { /* ... completa ... */ shoot() { /* ... */ } }
        class Enemy { /* ... completa, con bossHP e speedMultiplier nel costruttore, takeDamage, stomp ... */ }
        class Collectible { /* ... completa, con type e onCollect ... */ }
        class Platform { /* ... completa ... */ }
        class Projectile { /* ... completa ... */ }
        class Camera { /* ... completa ... */ }


        // ----- DEFINIZIONE LIVELLI e POPOLAMENTO -----
        // (Incolla qui baseLevelConfigs e la funzione populateLevel, e la generazione di levelData)
        const baseLevelConfigs = [ /* ... definisci 5 configurazioni base diverse ... */ ];
        const levelData = [];
        function populateLevel(baseConfig, levelIdx) { /* ... implementa logica per rendere i livelli pi√π pieni ... */ return baseConfig; }
        for(let i=0; i<NUM_LEVELS; i++){
            //  Assicurati che baseLevelConfigs[i] esista o usa un fallback
            levelData.push(populateLevel(baseLevelConfigs[i] || baseLevelConfigs[0], i));
        }
        if(levelData[4] && levelData[4].enemies) { // Assicura che il boss esista e abbia HP corretto
            let bossConfig = levelData[4].enemies.find(e => e.isBoss);
            if(bossConfig) bossConfig.bossHP = 10; else console.error("Boss non trovato in levelData[4]");
        }


        // ----- FUNZIONI DI GIOCO -----
        function resizeCanvas() {
            canvas.width = GAME_WIDTH; canvas.height = GAME_HEIGHT;
            const availableWidth = window.innerWidth * 0.98;
            let availableHeight = window.innerHeight * 0.95 - (document.getElementById('homeButton')?.offsetHeight || 40);
            if (isMobile) availableHeight -= (touchControlsContainer.offsetHeight + 20 || 80); // Spazio per controlli touch

            const scaleX = availableWidth / GAME_WIDTH; const scaleY = availableHeight / GAME_HEIGHT;
            scaleFactor = Math.min(scaleX, scaleY, 1.5);

            gameContainer.style.width = GAME_WIDTH * scaleFactor + 'px';
            gameContainer.style.height = GAME_HEIGHT * scaleFactor + 'px';

            if (isMobile) {
                touchControlsContainer.style.display = 'flex';
                touchControlsContainer.style.width = Math.min(GAME_WIDTH * scaleFactor, availableWidth * 0.95) + 'px';
            } else {
                touchControlsContainer.style.display = 'none';
            }
            if (gameState !== 'LOADING') draw();
        }
        window.addEventListener('resize', resizeCanvas);

        function initTitleScreenElements() { /* ... come prima ... */ }
        function loadLevel(levelIdx) { /* ... come prima, incluso reset projectiles e powerup ... */ }
        
        function resetGame(startLevelZero = true) {
            score = 0; lives = INITIAL_LIVES;
            currentLevelIndex = startLevelZero ? 0 : currentLevelIndex;
            updateScoreDisplay(); updateLivesDisplay();
            loadLevel(currentLevelIndex);
            gameState = 'PLAYING';
            hideAllScreens(); titleScreenContainer.style.display = 'none';
            uiLayer.style.display = 'flex';
            powerUpTimerDisplay.style.display = 'none';
            if(isMobile) shootTouchButton.style.display = 'none';
        }
        function startGameFlow() { resetGame(true); }

        function showTitleScreen() {
            gameState = 'TITLE_SCREEN';
            if (!titleScreenElements.fabio) initTitleScreenElements(); // Inizializza solo se non gi√† fatto
            hideAllScreens(); titleScreenContainer.style.display = 'flex';
            uiLayer.style.display = 'none'; powerUpTimerDisplay.style.display = 'none';
            if(isMobile) shootTouchButton.style.display = 'none';
            draw();
        }
        function hideAllScreens() { /* ... gameOverScreen, winScreen, levelCompleteScreen ... */ }
        // ... (loseLife, completeLevel, proceedToNextLevel, setGameOver, setGameWin come prima) ...
        // ... (updateScoreDisplay, updateLivesDisplay come prima) ...

        // ----- INPUT HANDLING -----
        const keys = { left: false, right: false, jump: false, shoot: false };
        // ... (event listener tastiera PC come prima, usando KeyX o ControlLeft per sparare) ...
        // ... (setupTouchButtonEvents per pulsanti HTML come prima) ...
        if (isMobile) setupTouchButtonEvents();
        function handleInput() { /* ... come prima, leggendo l'oggetto `keys` ... */ }

        // ----- UPDATE & DRAW -----
        function updateTitleScreen(deltaTime) { /* ... come prima ... */ }
        function update(deltaTime) {
            if (gameState === 'PLAYING') {
                 handleInput();
                 player.update(platforms);
                 projectiles.forEach(p => p.update());
                 projectiles = projectiles.filter(p => p.active);
                 enemies.forEach(enemy => { if(enemy.active) enemy.update(platforms); });
                 camera.follow(player);
                 // Collisioni
                 projectiles.forEach(proj => { enemies.forEach(enemy => { /* ... */ }); });
                 enemies.forEach(enemy => { if (enemy.active && player.collidesWith(enemy)) { /* ... */ } });
                 collectibles.forEach((collectible, index) => { if (collectible.active && player.collidesWith(collectible)) { collectible.onCollect(); } });
                 collectibles = collectibles.filter(collectible => collectible.active);
                 // Power-up logic
                 if (chefFuriosoActive) { /* ... timer, display, visibilit√† pulsante spara ... */ }
                 if (currentLevelIndex >= 2 && monstersKilledForPowerUp >= MONSTERS_FOR_POWERUP_THRESHOLD) { /* ... spawn powerup ... */ }
                 // Level progression
                 const requiredScoreForNext = (currentLevelIndex + 1) * SCORE_PER_LEVEL;
                 if (currentLevelIndex === NUM_LEVELS - 1) { /* ... boss sconfitto E score ... */ }
                 else if (score >= requiredScoreForNext) { completeLevel(); }

            } else if (gameState === 'TITLE_SCREEN') {
                updateTitleScreen(deltaTime);
            }
        }

        function drawTitleScreen() { /* ... come prima ... */ }
        function draw() {
            if (gameState === 'LOADING') { /* ... caricamento ... */ return; }
            if (gameState === 'TITLE_SCREEN') { drawTitleScreen(); }
            else if (gameState === 'PLAYING') {
                // Sfondo, piattaforme, collezionabili, nemici, proiettili, giocatore
                if (backgroundDrawers[currentLevelIndex]) backgroundDrawers[currentLevelIndex](ctx, GAME_WIDTH, GAME_HEIGHT);
                else { ctx.fillStyle = levelBackgroundColors[currentLevelIndex] || '#333'; ctx.fillRect(0,0,GAME_WIDTH,GAME_HEIGHT); }
                ctx.save(); camera.apply(ctx);
                platforms.forEach(p => p.draw(ctx)); collectibles.forEach(c => c.draw(ctx));
                enemies.forEach(e => e.draw(ctx)); projectiles.forEach(p => p.draw(ctx));
                player.draw(ctx);
                ctx.restore();
            } else { // Schermate modali HTML, disegna solo lo sfondo del gioco dietro
                 if (backgroundDrawers[currentLevelIndex]) backgroundDrawers[currentLevelIndex](ctx, GAME_WIDTH, GAME_HEIGHT);
                 else { ctx.fillStyle = levelBackgroundColors[currentLevelIndex] || '#333'; ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT); }
            }
        }

        // ----- GAME LOOP -----
        let lastTime = 0;
        function gameLoop(timestamp) { /* ... come prima, con deltaTime clampato ... */ }

        // ----- INIZIALIZZAZIONE -----
        startButton.addEventListener('click', startGameFlow);
        restartButton.addEventListener('click', startGameFlow);
        playAgainButton.addEventListener('click', startGameFlow);
        nextLevelButton.addEventListener('click', proceedToNextLevel);

        resizeCanvas();
        if (imagesLoaded < TOTAL_IMAGES) { gameState = 'LOADING'; draw(); }
        else { showTitleScreen(); }
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>
