<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Team Due Mori ‚Äì¬†Chat</title>

<style>
/* RESET --------------------------------------------------------------- */
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;font-family:-apple-system,Segoe UI,Roboto,Arial,sans-serif;}

/* ----------------------- MOBILE FINO A 600PX ------------------------ */
@media (max-width:600px){

/* ‚Üì‚Üì‚Üì variabili dinamiche impostate via JS ‚Üì‚Üì‚Üì */
:root{
  --vh:1vh;                 /* 1% viewport reale (fallback) */
  --safeT: env(safe-area-inset-top);
  --safeB: env(safe-area-inset-bottom);
  --kb:0px;                 /* spazio tastiera rilevato */
}

/* pagina bloccata quando chat open ----------------------------------- */
body.chat-lock{position:fixed;overflow:hidden;width:100%;}

/* ===== PULSANTE FLOTANTE WHATSAPP =================================== */
#chatBtn{position:fixed;z-index:1000;border:none;cursor:pointer;
         width:60px;height:60px;border-radius:50%;
         background:#25d366 url("https://img.icons8.com/ios-filled/50/ffffff/chat--v1.png") center/60% no-repeat;
         top:calc(1rem + var(--safeT));right:1rem;box-shadow:0 4px 12px rgba(0,0,0,.25);}
#chatBtn:active{transform:scale(.92);}

/* ===== CONTAINER CHAT =============================================== */
#chatBox{
  position:fixed;inset:0;width:100vw;
  height:calc(var(--vh)*100);           /* viewport dinamica reale */
  background:#ece5dd;display:none;flex-direction:column;
  overscroll-behavior:contain;touch-action:pan-y;z-index:1100;
}
#chatBox::before{content:"";position:absolute;inset:0;z-index:0;
  background:url("https://raw.githubusercontent.com/raj457036/whatsapp-chat-background/master/bg.png") 0 0/540px repeat;
  opacity:.15;}

/* ===== TOPBAR ======================================================= */
.topbar{
  display:flex;align-items:center;gap:10px;color:#fff;font-weight:500;font-size:16px;
  background:#075e54;z-index:2;position:relative;padding:10px 16px;
  padding-top:calc(10px + var(--safeT));
}
.topbar img.avatar{width:34px;height:34px;border-radius:50%;object-fit:cover;}
.topbar .name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.topbar .ico{width:24px;height:24px;filter:invert(1) brightness(1.8);cursor:pointer;}

/* ===== BODY MESSAGGI ================================================ */
#msgArea{
  flex:1;overflow-y:auto;padding:10px 12px 100px 12px;            /* extra bottom = input height */
  display:flex;flex-direction:column;gap:6px;z-index:1;
}

/* ===== INPUTBAR ===================================================== */
.inputbar{
  display:flex;align-items:center;gap:8px;background:#f0f0f0;
  padding:8px 8px calc(8px + var(--safeB));z-index:2;
  position:relative;transition:transform .2s;
}
.inputbar.fixed{position:fixed;left:0;right:0;bottom:0;}         /* -> JS la rende fixed */
.inputbar input{flex:1;border:none;border-radius:20px;padding:10px 12px;font-size:15px;background:#fff;}
.inputbar button{width:46px;height:46px;border:none;border-radius:50%;background:#25d366;
                 display:flex;align-items:center;justify-content:center;}
.ico.inline{filter:none;width:28px;height:28px;}

/* ===== BUBBLE STYLE ================================================ */
.msg{max-width:80%;position:relative;display:flex;flex-direction:column;font-size:14px;}
.bub{padding:6px 8px 18px;border-radius:8px;line-height:1.35;box-shadow:0 1px 1px rgba(0,0,0,.08);}
.time{position:absolute;bottom:2px;right:6px;font-size:11px;opacity:.6;white-space:nowrap;}

.self .bub{background:#d1f8c6;border-radius:8px 0 8px 8px;align-self:flex-end;}
.self .bub::after{content:"‚úî‚úî";font-size:11px;position:absolute;bottom:2px;right:-18px;
                  color:#34b7f1;font-weight:700;font-family:Arial,Helvetica,sans-serif;}
.bot  .bub{background:#fff;border-radius:0 8px 8px 8px;}
}

/* --------------------- DESKTOP BLOCCO -------------------------------- */
@media (min-width:601px){
 body::before{content:'üõë Solo smartphone';display:flex;align-items:center;justify-content:center;
              height:100vh;width:100%;font-size:2.5rem;background:#000;color:#fff;text-align:center;}
 #chatBtn,#chatBox{display:none!important;}
 html,body{overflow:hidden;}
}
</style>
</head>
<body>

<!-- BUTTON -->
<button id="chatBtn" aria-label="apri chat"></button>

<!-- CHAT -->
<div id="chatBox">
  <div class="topbar">
     <img src="avatar-roberta.jpg" class="avatar" alt="">
     <span class="name">Ro‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
     <img src="https://img.icons8.com/ios-glyphs/30/ffffff/video-call.png" class="ico" alt="video">
     <img src="https://img.icons8.com/ios-glyphs/30/ffffff/phone.png" class="ico" alt="call">
     <span id="closeChat" class="ico" style="font-size:28px;">‚úï</span>
  </div>

  <div id="msgArea"></div>

  <form id="chatForm" class="inputbar fixed" autocomplete="off">
     <img src="https://img.icons8.com/ios-glyphs/30/000000/plus-math.png" class="ico inline">
     <input id="txt" placeholder="Messaggio">
     <img src="https://img.icons8.com/ios-glyphs/30/000000/camera.png" class="ico inline">
     <img src="https://img.icons8.com/ios-glyphs/30/000000/image.png" class="ico inline">
     <button type="submit"><img src="https://img.icons8.com/ios/50/ffffff/filled-sent.png" style="width:24px"></button>
  </form>
</div>

<script>
/* ------------ ELEMENTI  -------------------------------------------- */
const btn   = document.getElementById('chatBtn');
const box   = document.getElementById('chatBox');
const close = document.getElementById('closeChat');
const txt   = document.getElementById('txt');
const form  = document.getElementById('chatForm');
const area  = document.getElementById('msgArea');
const hist  = [];

/* ------------ OPEN / CLOSE ----------------------------------------- */
btn.onclick   = ()=>{lockBody(true);box.style.display='flex';txt.focus();};
close.onclick = ()=>{box.style.display='none';lockBody(false);};

function lockBody(state){document.body.classList.toggle('chat-lock',state);}

/* ------------ BUBBLE APPENDER -------------------------------------- */
function bubble(who,text){
  const wrap=document.createElement('div');
  wrap.className=`msg ${who}`;
  const now=new Date().toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'});
  wrap.innerHTML=`<div class="bub">${text}<span class="time">${now}</span></div>`;
  area.appendChild(wrap);area.scrollTop=area.scrollHeight;
}

/* ------------ SEND & FETCH ----------------------------------------- */
form.addEventListener('submit',async e=>{
  e.preventDefault();
  const t=txt.value.trim();if(!t)return;
  bubble('self',t);hist.push({role:'user',content:t});txt.value='';
  try{
    const r=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({message:t,history:hist})});
    const {reply}=await r.json();
    bubble('bot',reply);hist.push({role:'assistant',content:reply});
  }catch{bubble('bot','Errore di rete üöß');}
});

/* ------------ VIEWPORT¬†&¬†KEYBOARD FIX ------------------------------ */
(function(){
  /* 1) imposta --vh reale (per Safari < 15.6) */
  const setVH=()=>{const h=window.visualViewport?visualViewport.height:window.innerHeight;
                   document.documentElement.style.setProperty('--vh',`${h*0.01}px`);};
  setVH();window.visualViewport?
    (visualViewport.addEventListener('resize',setVH),visualViewport.addEventListener('scroll',setVH))
    :window.addEventListener('resize',setVH);

  /* 2) segue tastiera: translateY & bottom padding ------------------- */
  if(window.visualViewport){
    const fix=()=>{
      const gap=Math.max(0,window.innerHeight-visualViewport.height-visualViewport.offsetTop);
      form.style.transform=`translateY(-${gap}px)`;
      area.style.paddingBottom=`${100+gap}px`;
    };
    visualViewport.addEventListener('resize',fix);
    visualViewport.addEventListener('scroll',fix);
    fix();
  }
})();

/* ------------ BLOCCA RUBBERBAND ------------------------------------ */
['touchstart','touchmove'].forEach(ev=>{
  box.addEventListener(ev,e=>{
    if(e.touches.length>1)return;                /* pinch ok */
    const el=area;                               /* scroll solo nell'area msg */
    const atTop=el.scrollTop===0;
    const atBottom=el.scrollHeight-el.scrollTop===el.clientHeight;
    if((atTop&&e.touches[0].clientY>e.touches[0].screenY)|| /* verso gi√π da top */
       (atBottom&&e.touches[0].clientY<e.touches[0].screenY)){
        e.preventDefault();                      /* stop overscroll */
    }
  },{passive:false});
});
</script>
</body>
</html>
