<!DOCTYPE html><html lang="it"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Don¬†Alfred¬†Chat</title>

<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;font-family:-apple-system,BlinkMacSystemFont,Segoe¬†UI,Roboto,Arial,sans-serif}

/* -------- MOBILE ‚â§600¬†px -------- */
@media (max-width:600px){
:root{--safeT:env(safe-area-inset-top);--safeB:env(safe-area-inset-bottom);
      --safeL:env(safe-area-inset-left);--safeR:env(safe-area-inset-right);}

/* pulsante */
#btn{position:fixed;top:1rem;right:1rem;width:60px;height:60px;border:none;border-radius:50%;
     background:#25d366 url("https://img.icons8.com/ios-filled/50/ffffff/chat--v1.png") center/60% no-repeat;
     box-shadow:0 4px 14px rgba(0,0,0,.25);z-index:1000;cursor:pointer}
#btn:active{transform:scale(.9)}

/* container chat */
#box{position:fixed;inset:0;display:none;width:100vw;height:100vh;background:#ece5dd;z-index:1100}
#box::before{content:"";position:absolute;inset:0;background:url("https://raw.githubusercontent.com/raj457036/whatsapp-chat-background/master/bg.png")0/540px repeat;opacity:.15}

/* top‚Äëbar (ridotta) */
.top{
  position:fixed;
  top:0;
  left:var(--safeL);
  right:var(--safeR);
  height:44px;
  padding:var(--safeT) 16px 0;
  background:#075e54;
  color:#fff;
  display:flex;align-items:center;gap:10px;
  font-weight:500;font-size:15px;          /* 1¬†px in meno per stare larghi */
  z-index:5;
}
.top .name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.top button{background:none;border:none;color:#fff;font-size:24px;cursor:pointer;line-height:0}

/* barra input invariata */
.bottom{
  position:fixed;
  left:var(--safeL);right:var(--safeR);bottom:0;
  height:60px;
  padding:8px 8px calc(8px + var(--safeB));
  background:#f0f0f0;display:flex;align-items:center;gap:8px;z-index:5;transition:bottom .15s;
}
.bottom input{flex:1;border:none;border-radius:20px;padding:10px 12px;font-size:15px;background:#fff}
.bottom button{width:46px;height:46px;border:none;border-radius:50%;background:#25d366;display:flex;align-items:center;justify-content:center}

/* lista ‚Äì¬†offset 44¬†px invece di¬†52 */
#list{
  position:absolute;
  left:var(--safeL);right:var(--safeR);
  overflow-y:auto;display:flex;flex-direction:column;gap:6px;
  padding:10px calc(12px + var(--safeR)) 10px calc(12px + var(--safeL));
  top:calc(44px + var(--safeT));
  bottom:calc(60px + var(--safeB));
  scroll-behavior:smooth;
}

/* bolle invariato */
.msg{max-width:80%;display:flex;flex-direction:column;font-size:14px;position:relative}
.b{padding:6px 8px 18px;border-radius:8px;line-height:1.35;box-shadow:0 1px 1px rgba(0,0,0,.07)}
.t{position:absolute;bottom:2px;right:6px;font-size:11px;opacity:.6}
.me  .b{background:#d1f8c6;border-radius:8px 0 8px 8px;align-self:flex-end}
.me  .b::after{content:"‚úî‚úî";position:absolute;bottom:2px;right:-18px;font-size:11px;color:#34b7f1;font-weight:700}
.you .b{background:#fff;border-radius:0 8px 8px 8px}
}

/* desktop block (invariato) */
@media (min-width:601px){
body::before{content:'üõë¬†Solo¬†smartphone';display:flex;align-items:center;justify-content:center;height:100vh;width:100%;
             font-size:2.5rem;background:#000;color:#fff;text-align:center}
#btn,#box{display:none!important}html,body{overflow:hidden}
}
</style>
</head><body>

<button id="btn" aria-label="Apri¬†chat"></button>

<div id="box">
  <div class="top"><span class="name">Don¬†Alfred ü§µüèª‚Äç‚ôÇÔ∏è</span><button id="close">‚úï</button></div>
  <div id="list"></div>
  <form class="bottom" id="bar" autocomplete="off">
    <input id="txt" placeholder="Messaggio">
    <button type="submit"><img src="https://img.icons8.com/ios/50/ffffff/filled-sent.png" style="width:24px"></button>
  </form>
</div>

<script>
const $=s=>document.querySelector(s),btn=$('#btn'),box=$('#box'),cls=$('#close'),
      list=$('#list'),bar=$('#bar'),txt=$('#txt');let history=[];

/* open/close */
btn.onclick =()=>{box.style.display='block';document.body.style.overflow='hidden';txt.focus();recalc();}
cls.onclick =()=>{box.style.display='none';document.body.style.overflow='';}

/* bubble */
function add(who,t){const h=new Date().toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'});
 list.insertAdjacentHTML('beforeend',`<div class="msg ${who}"><div class="b">${t}<span class="t">${h}</span></div></div>`);
 list.scrollTop=list.scrollHeight}

/* send */
bar.addEventListener('submit',async e=>{
 e.preventDefault();const v=txt.value.trim();if(!v)return;
 add('me',v);history.push({role:'user',content:v});txt.value='';
 try{const r=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({message:v,history})}),{reply}=await r.json();
        add('you',reply);history.push({role:'assistant',content:reply})}
 catch{add('you','Errore di rete üò¢')}
})

/* tastiera follow */
function recalc(){
  const vv=window.visualViewport;if(!vv)return;
  const gap=Math.max(0,innerHeight-vv.height-vv.offsetTop);
  bar.style.bottom=`calc(${gap}px + var(--safeB))`;
  list.style.bottom=`calc(60px + var(--safeB) + ${gap}px)`;
}
if(window.visualViewport){
 visualViewport.addEventListener('resize',recalc);
 visualViewport.addEventListener('scroll',recalc);
}

/* overscroll stop */
['touchstart','touchmove'].forEach(ev=>{
 box.addEventListener(ev,e=>{
  if(e.touches.length>1)return;
  const top=list.scrollTop===0,bot=Math.abs(list.scrollHeight-list.scrollTop-list.clientHeight)<1,
        dir=Math.sign(e.touches[0].clientY-e.touches[0].screenY);
  if((top&&dir>0)||(bot&&dir<0))e.preventDefault();
 },{passive:false});
});
</script>
</body></html>
