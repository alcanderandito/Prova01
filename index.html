<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Home • Team Due Mori</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

  <style>
    :root {
      --font-primary: 'Roboto', -apple-system, Segoe UI, Arial, sans-serif;
      --font-secondary: 'Oswald', sans-serif;

      --color-text-light: #ffffff;
      --color-text-dark: #333;
      --color-text-muted: #6c757d;
      --color-text-placeholder: #888;
      --color-text-error: #dc3545;

      --color-bg-navbar: rgba(40, 40, 40, 0.85);
      --color-bg-navbar-solid: #282828;
      --color-bg-dropdown: #ffffff;
      --color-bg-dropdown-hover: #f8f9fa;
      --color-bg-dropdown-submenu: #f1f1f1;
      --color-bg-dynamic-fallback: #1a1a1a;
      --color-bg-overlay: rgba(0, 0, 0, 0.6);

      --color-accent-primary: #5cb85c;
      --color-accent-primary-light: #81c784;
      --color-accent-primary-dark: #388e3c;

      --color-chat-button: #25d366;
      --color-chat-button-hover: #2ecc71;
      --color-chat-button-active: #22b85b;

      --shadow-soft: rgba(0,0,0,0.1);
      --shadow-medium: rgba(0,0,0,0.2);
      --shadow-strong: rgba(0,0,0,0.3);
      --shadow-text-hero: rgba(0, 0, 0, 0.7);
      --shadow-text-hero-hover: rgba(255, 255, 255, 0.3);

      --navbar-height: 60px;
      --border-radius-small: 4px;
      --border-radius-medium: 8px;

      --transition-duration-fast: 0.2s;
      --transition-duration-normal: 0.3s;

      --z-index-background: 0;
      --z-index-snow: 1; 
      --z-index-main-content: 2;
      --z-index-hero-title: 3;
      --z-index-page-overlay: 490;
      --z-index-navbar: 500;
      --z-index-dropdown-content: 501;
      --z-index-chat-button: 1000;
    }

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; font-size: 16px; }
    body {
      font-family: var(--font-primary);
      height: 100%;
      overflow-x: hidden;
      background-color: var(--color-bg-dynamic-fallback);
      line-height: 1.6;
      color: var(--color-text-dark);
    }
    body.menu-open { overflow-y: hidden; }

    .navbar {
      background-color: var(--color-bg-navbar);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 0 20px;
      height: var(--navbar-height);
      position: fixed; top: 0; left: 0; width: 100%;
      z-index: var(--z-index-navbar);
      display: flex; align-items: center;
      box-shadow: 0 2px 10px var(--shadow-medium);
      transition: background-color var(--transition-duration-fast) ease;
    }

    .dropdown-button {
      background: transparent; color: var(--color-text-light);
      padding: 10px; font-size: 1rem; font-weight: 500;
      border: none; cursor: pointer; border-radius: var(--border-radius-small);
      font-family: var(--font-primary);
      transition: background-color var(--transition-duration-fast) ease, color var(--transition-duration-fast) ease;
      display: flex; align-items: center;
      text-shadow: 0 1px 2px var(--shadow-medium);
      position: relative;
    }
    .dropdown-button:hover, .dropdown-button:focus-visible {
      background-color: rgba(255,255,255,0.1); outline: none;
    }
    .menu-icon-container {
      width: 24px; height: 20px;
      display: flex; flex-direction: column; justify-content: space-between;
      margin-right: 10px; cursor: pointer; z-index: 1;
    }
    .menu-icon-container .line {
      display: block; height: 3px; width: 100%;
      background-color: var(--color-text-light); border-radius: 3px;
      transition: transform var(--transition-duration-normal) ease-in-out,
                  opacity var(--transition-duration-normal) ease-in-out;
    }
    .dropdown-button[aria-expanded="true"] .menu-icon-container .line1 { transform: translateY(8.5px) rotate(45deg); }
    .dropdown-button[aria-expanded="true"] .menu-icon-container .line2 { opacity: 0; }
    .dropdown-button[aria-expanded="true"] .menu-icon-container .line3 { transform: translateY(-8.5px) rotate(-45deg); }
    .dropdown-button-text { transition: color var(--transition-duration-fast) ease; }

    .dropdown-content {
      display: none; position: absolute;
      top: calc(var(--navbar-height) - 10px); left: 10px;
      background-color: var(--color-bg-dropdown);
      min-width: 250px; box-shadow: 0 8px 25px var(--shadow-strong);
      z-index: var(--z-index-dropdown-content);
      border-radius: var(--border-radius-medium);
      overflow: hidden; opacity: 0; transform: translateY(10px);
      transition: opacity var(--transition-duration-fast) ease-out, transform var(--transition-duration-fast) ease-out;
      max-height: calc(100vh - var(--navbar-height) - 20px); overflow-y: auto;
    }
    .dropdown-content.show { display: block; opacity: 1; transform: translateY(0); }
    .dropdown-content .menu-loading-placeholder, .dropdown-content .menu-message {
      padding: 20px; color: var(--color-text-placeholder); font-style: italic; text-align: center;
    }
    .dropdown-content ul { list-style-type: none; }
    
    /* Stile per <a> che sono figli diretti di <li> che sono figli diretti di <ul> dentro .dropdown-content */
    /* Questo copre le voci principali e i trigger dei sottomenu se sono direttamente sotto <ul> */
    .dropdown-content > ul > li > a {
      color: var(--color-text-dark); padding: 12px 20px; text-decoration: none;
      display: block; font-size: 0.95rem; font-weight: 400;
      transition: background-color var(--transition-duration-fast) ease, color var(--transition-duration-fast) ease, padding-left var(--transition-duration-fast) ease;
      border-bottom: 1px solid #eee;
    }
    .dropdown-content > ul > li:last-child > a { border-bottom: none; }
    .dropdown-content > ul > li > a:hover, 
    .dropdown-content > ul > li > a:focus-visible {
      background-color: var(--color-bg-dropdown-hover); color: var(--color-accent-primary);
      padding-left: 25px; outline: none;
    }
    
    /* Stili CSS specifici per la struttura del tuo menu.html (con .submenu-item, .submenu-trigger, .submenu) */
    .dropdown-content li.submenu-item > a.submenu-trigger { /* Il trigger del sottomenu */
        display: flex; /* Necessario per allineare la freccia */
        align-items: center;
        justify-content: space-between; /* Spinge la freccia a destra */
        /* Eredita gli altri stili da .dropdown-content > ul > li > a se è un <a> */
    }
    .dropdown-content li.submenu-item > a.submenu-trigger .arrow {
      transition: transform var(--transition-duration-normal) ease; font-size: 0.8em; margin-left: 8px;
    }
    .dropdown-content li.submenu-item > a.submenu-trigger.open .arrow { transform: rotate(180deg); }

    .dropdown-content li.submenu-item .submenu { /* Il contenitore del sottomenu */
      display: none; /* Nascosto di default */
      padding-left: 0; 
      background-color: var(--color-bg-dropdown-submenu);
      border-left: 3px solid var(--color-accent-primary);
      margin: 5px 10px 5px 15px; 
      border-radius: var(--border-radius-small);
    }
    .dropdown-content li.submenu-item .submenu.open { display: block; } /* Mostra quando ha la classe 'open' */

    .dropdown-content li.submenu-item .submenu ul li a { /* Le singole voci dentro al sottomenu */
      padding: 10px 15px 10px 20px; 
      font-size: 0.9em; 
      border-bottom: 1px solid #e0e0e0;
      color: var(--color-text-dark); 
      display: block; 
      text-decoration: none;
      transition: background-color var(--transition-duration-fast) ease, color var(--transition-duration-fast) ease, padding-left var(--transition-duration-fast) ease;
    }
    .dropdown-content li.submenu-item .submenu ul li:last-child a { border-bottom: none; }
    .dropdown-content li.submenu-item .submenu ul li a:hover,
    .dropdown-content li.submenu-item .submenu ul li a:focus-visible {
      background-color: #e9e9e9; 
      color: var(--color-text-dark); 
      padding-left: 25px;
    }

    .page-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: var(--color-bg-overlay);
      z-index: var(--z-index-page-overlay);
      opacity: 0; transition: opacity var(--transition-duration-normal) ease;
    }
    .page-overlay.active { display: block; opacity: 1; }

    #goChatContainer { position: fixed; bottom: 25px; right: 25px; z-index: var(--z-index-chat-button); }
    #goChat{
      width: 60px; height: 60px; border: none; border-radius: 50%;
      background: var(--color-chat-button) url("https://img.icons8.com/ios-filled/50/ffffff/chat--v1.png") center/50% no-repeat;
      box-shadow: 0 5px 15px var(--shadow-medium), 0 2px 8px var(--shadow-soft);
      cursor: pointer; transition: all var(--transition-duration-fast) ease-out;
    }
    #goChat:hover, #goChat:focus-visible {
      transform: translateY(-4px) scale(1.1);
      box-shadow: 0 8px 20px var(--color-chat-button-hover), 0 4px 10px var(--shadow-medium);
      background-color: var(--color-chat-button-hover);
      outline: 3px solid rgba(255,255,255,0.3); outline-offset: 2px;
    }
    #goChat:active{ transform: translateY(0px) scale(1); background-color: var(--color-chat-button-active); }

    #dynamic-background-container {
      position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
      z-index: var(--z-index-background); overflow: hidden;
      background-color: var(--color-bg-dynamic-fallback);
    }
    .background-slide {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background-size: cover; background-position: center center;
      opacity: 0; transition: opacity 1.8s cubic-bezier(0.4, 0, 0.2, 1);
      transform: scale(1.03);
    }
    .background-slide.active {
      opacity: 1; animation: kenburns 20s infinite alternate ease-in-out;
    }
    @keyframes kenburns { 0% { transform: scale(1.03) translate(0%, 0%); } 100% { transform: scale(1.10) translate(-1%, 1%); } }
    .background-slide.active.even-slide-kenburns { animation-name: kenburns-alt; }
    @keyframes kenburns-alt { 0% { transform: scale(1.03) translate(0%, 0%); } 100% { transform: scale(1.10) translate(1%, -1%); } }

    #hero-title-container {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      text-align: center; color: var(--color-text-light);
      z-index: var(--z-index-hero-title);
      padding: 20px; width: 90%; max-width: 900px;
      transition: text-shadow var(--transition-duration-fast) ease;
    }
    #hero-title-container:hover {
      text-shadow: 0 0 15px var(--shadow-text-hero-hover), 0 0 25px var(--shadow-text-hero-hover);
    }
    #hero-title-container h1, #hero-title-container p {
      opacity: 0; transform: translateY(20px);
    }
    #hero-title-container h1 {
      font-family: var(--font-secondary); font-size: 2.8rem; font-weight: 700;
      margin-bottom: 0.5em; line-height: 1.2; letter-spacing: 1.5px; text-transform: uppercase;
      background: linear-gradient(45deg, var(--color-text-light), #f0e0c0);
      -webkit-background-clip: text; background-clip: text; color: transparent;
      filter: drop-shadow(0px 4px 8px var(--shadow-text-hero));
      animation: fadeInUp 0.8s 0.5s ease-out forwards;
    }
    #hero-title-container p {
      font-family: var(--font-primary); font-size: 1.1rem; font-weight: 300;
      line-height: 1.7; opacity: 0;
      text-shadow: 0px 2px 6px var(--shadow-text-hero);
      max-width: 700px; margin-left: auto; margin-right: auto;
      animation: fadeInUp 0.8s 0.8s ease-out forwards;
    }
    @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

    .main-content {
      position: relative; z-index: var(--z-index-main-content);
      padding-top: calc(var(--navbar-height) + 30px);
      padding-left: 25px; padding-right: 25px; padding-bottom: 80px;
      min-height: 100vh;
    }

    #particle-effect-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: var(--z-index-snow);
    }

    @media (max-width: 768px) {
      :root { --navbar-height: 55px; }
      .dropdown-button { padding: 8px; }
      .menu-icon-container { margin-right: 8px; width: 22px; height: 18px;}
      .menu-icon-container .line { height: 2.5px; }
      .dropdown-button[aria-expanded="true"] .menu-icon-container .line1 { transform: translateY(7.75px) rotate(45deg); }
      .dropdown-button[aria-expanded="true"] .menu-icon-container .line3 { transform: translateY(-7.75px) rotate(-45deg); }

      .dropdown-content {
        position: fixed; top: var(--navbar-height); left: 0;
        width: 100vw; max-width: 100vw; min-width: auto;
        height: calc(100vh - var(--navbar-height)); max-height: calc(100vh - var(--navbar-height));
        border-radius: 0; margin-top: 0;
        box-shadow: none; border-top: 1px solid rgba(255,255,255,0.1);
        transform: translateX(-100%);
        transition: transform var(--transition-duration-normal) ease-in-out;
      }
      .dropdown-content.show { transform: translateX(0); }
      .dropdown-content > ul > li > a { padding: 15px 25px; font-size: 1rem; }
      
      .dropdown-content li.submenu-item .submenu {
        margin: 0; border-radius: 0; border-left: none; border-top: 2px solid var(--color-accent-primary);
      }
      .dropdown-content li.submenu-item .submenu ul li a { padding-left: 35px; }

      #hero-title-container h1 { font-size: 2.2rem; letter-spacing: 1px; }
      #hero-title-container p { font-size: 1rem; line-height: 1.6; }
      #goChat { width: 55px; height: 55px; background-size: 45%; }
      #goChatContainer { bottom: 20px; right: 20px; }
    }
    @media (min-width: 769px) {
      #hero-title-container h1 { font-size: 3.5rem; letter-spacing: 2px;}
      #hero-title-container p { font-size: 1.25rem; }
    }
    @media (min-width: 993px) {
      #hero-title-container h1 { font-size: 4.2rem; }
      #hero-title-container p { font-size: 1.4rem; }
    }
  </style>
</head>
<body>
  <div class="page-overlay" id="pageOverlay"></div>

  <header class="navbar">
    <nav class="dropdown">
        <button class="dropdown-button" id="menuButton" aria-haspopup="true" aria-expanded="false" aria-controls="menuContent">
            <span class="menu-icon-container" aria-hidden="true">
                <span class="line line1"></span>
                <span class="line line2"></span>
                <span class="line line3"></span>
            </span>
            <span class="dropdown-button-text">Menu</span>
        </button>
        <div id="menuContent" class="dropdown-content" role="menu" aria-labelledby="menuButton">
            <p class="menu-loading-placeholder">Caricamento menu...</p>
        </div>
    </nav>
  </header>
  
  <canvas id="particle-effect-canvas"></canvas>

  <div id="dynamic-background-container"></div>
  <div id="hero-title-container"><h1>Team Due Mori</h1><p>Il Dream Team (almeno la mattina, dopo il caffè).</p></div>

  <main class="main-content">
   </main>

  <div id="goChatContainer"><a href="chat.html" aria-label="Apri chat"><button id="goChat" aria-label="Avvia chat"></button></a></div>

  <audio id="indexPageSong" src="indexsong.mp3" loop preload="metadata"></audio>

  <script>
    // rendi le funzioni accessibili globalmente per gli onclick in menu.html
    window.toggleSubmenu = function(event, triggerElement) {
      console.log("GLOBAL toggleSubmenu: Chiamata per:", triggerElement.textContent.trim());
      if (event) {
        event.preventDefault();
        // event.stopPropagation(); // L'onclick in menu.html lo fa già
      }

      const parentLi = triggerElement.closest('.submenu-item');
      if (!parentLi) {
        console.warn("GLOBAL toggleSubmenu: Elemento .submenu-item non trovato per il trigger:", triggerElement);
        return;
      }
      const submenu = parentLi.querySelector('.submenu');

      if (submenu) {
        const isOpening = !submenu.classList.contains('open');
        // Opzionale: chiudi altri sottomenu
        if (isOpening && parentLi.parentElement) {
            Array.from(parentLi.parentElement.children).forEach(siblingLi => {
                if (siblingLi !== parentLi && siblingLi.classList.contains('submenu-item')) {
                    const otherSubmenu = siblingLi.querySelector('.submenu.open');
                    if (otherSubmenu) {
                        otherSubmenu.classList.remove('open');
                        const otherTrigger = siblingLi.querySelector('.submenu-trigger.open');
                        if (otherTrigger) {
                            otherTrigger.classList.remove('open');
                            if (otherTrigger.hasAttribute('aria-expanded')) otherTrigger.setAttribute('aria-expanded', 'false');
                        }
                    }
                }
            });
        }
        // Fine opzionale

        submenu.classList.toggle('open');
        triggerElement.classList.toggle('open'); // Per la freccia
        if (triggerElement.hasAttribute('aria-expanded')) {
            triggerElement.setAttribute('aria-expanded', submenu.classList.contains('open'));
        }
        console.log("GLOBAL toggleSubmenu: Stato sottomenu '" + triggerElement.textContent.trim() + "': " + (submenu.classList.contains('open') ? "aperto" : "chiuso"));
      } else {
        console.warn("GLOBAL toggleSubmenu: .submenu non trovato dentro a .submenu-item per:", triggerElement);
      }
    }

    window.closeAllSubmenus = function(container) {
      console.log("GLOBAL closeAllSubmenus: Chiamata.");
      if (!container) {
          console.warn("GLOBAL closeAllSubmenus: Nessun container fornito.");
          return;
      }
      container.querySelectorAll('.submenu.open').forEach(submenu => {
        submenu.classList.remove('open');
        const parentLi = submenu.closest('.submenu-item');
        if (parentLi) {
            const trigger = parentLi.querySelector('.submenu-trigger.open');
            if (trigger) {
                trigger.classList.remove('open');
                if (trigger.hasAttribute('aria-expanded')) trigger.setAttribute('aria-expanded', 'false');
            }
        }
      });
    }

    // Script principale
    (function() {
      console.log("SCRIPT: Inizio esecuzione blocco script IIFE.");

      const ready = (callback) => {
          if (document.readyState !== "loading") callback();
          else document.addEventListener("DOMContentLoaded", callback);
      };

      const menuButton = document.getElementById("menuButton");
      const menuContent = document.getElementById("menuContent");
      const pageOverlay = document.getElementById("pageOverlay");

      function toggleMenu() {
        console.log("MENU: toggleMenu chiamata.");
        const isCurrentlyExpanded = menuButton.getAttribute("aria-expanded") === "true";
        menuButton.setAttribute("aria-expanded", !isCurrentlyExpanded);
        menuContent.classList.toggle("show", !isCurrentlyExpanded);
        pageOverlay.classList.toggle("active", !isCurrentlyExpanded);
        document.body.classList.toggle("menu-open", !isCurrentlyExpanded);

        if (!isCurrentlyExpanded && (menuContent.querySelector('.menu-loading-placeholder') || menuContent.innerHTML.trim() === '')) {
          fetch('menu.html')
            .then(response => {
              if (!response.ok) { throw new Error(`Network response not ok: ${response.status}`); }
              return response.text();
            })
            .then(data => {
              menuContent.innerHTML = data.trim() === '' ? `<p class="menu-message">Menu vuoto.</p>` : data;
              // Inizializza aria-expanded per i trigger appena caricati
              menuContent.querySelectorAll('.submenu-trigger').forEach(trigger => {
                  if (trigger.hasAttribute('aria-expanded')) { // Solo se l'attributo è previsto
                    const parentLi = trigger.closest('.submenu-item');
                    if (parentLi) {
                        const submenu = parentLi.querySelector('.submenu');
                        trigger.setAttribute('aria-expanded', submenu && submenu.classList.contains('open'));
                    } else {
                        trigger.setAttribute('aria-expanded', 'false');
                    }
                  }
              });
              console.log("MENU: Contenuto caricato. Gli onclick in menu.html sono responsabili dei sottomenu.");
            })
            .catch(error => {
              menuContent.innerHTML = `<p class="menu-message" style="color: var(--color-text-error);">Errore caricamento menu.</p>`;
              console.error('MENU: Errore fetch menu.html:', error);
            });
        } else if (isCurrentlyExpanded) {
          if (typeof window.closeAllSubmenus === 'function') {
              window.closeAllSubmenus(menuContent);
          }
        }
      }

      if (menuButton) menuButton.addEventListener('click', toggleMenu); 
      else console.error("MENU: Bottone menu non trovato!");
      
      if (pageOverlay) { 
        pageOverlay.addEventListener('click', () => { 
          if (menuButton && menuButton.getAttribute("aria-expanded") === "true") toggleMenu(); 
        }); 
      }
      window.addEventListener('keydown', (event) => { 
        if (event.key === 'Escape' && menuButton && menuButton.getAttribute("aria-expanded") === "true") { 
          toggleMenu(); 
        } 
      });
      console.log("SCRIPT: Gestori eventi menu definiti.");

      function initDynamicBackground() {
        const container = document.getElementById('dynamic-background-container');
        if (!container) { console.error("SFONDO: #dynamic-background-container non trovato!"); return; }
        const images = ['home.PNG', 'home1.PNG', 'home2.PNG', 'home3.PNG', 'home4.PNG', 'home5.PNG', 'home6.PNG', 'home7.PNG'];
        if (images.length === 0) { console.warn("SFONDO: Nessuna immagine definita."); return; }
        let currentIndex = -1; const slideDuration = 7000; const animDurationCSS = 20;
        images.forEach((imgName, i) => { const slide = document.createElement('div'); slide.classList.add('background-slide'); try { new URL(imgName, window.location.href); slide.style.backgroundImage = `url('${imgName}')`; } catch (e) { console.error(`SFONDO: Nome immagine non valido "${imgName}".`, e); return; } if (i % 2 !== 0) slide.classList.add('even-slide-kenburns'); container.appendChild(slide); });
        const slides = container.querySelectorAll('.background-slide');
        if (slides.length === 0) { console.error("SFONDO: Nessuna slide creata."); return; }
        function nextSlide() { if (currentIndex >= 0 && slides[currentIndex]) { slides[currentIndex].classList.remove('active'); slides[currentIndex].style.animation = 'none'; void slides[currentIndex].offsetHeight; } currentIndex = (currentIndex + 1) % slides.length; if (slides[currentIndex]) { slides[currentIndex].classList.add('active'); const animName = slides[currentIndex].classList.contains('even-slide-kenburns') ? 'kenburns-alt' : 'kenburns'; slides[currentIndex].style.animation = `${animName} ${animDurationCSS}s infinite alternate ease-in-out`; } }
        nextSlide(); setInterval(nextSlide, slideDuration);
      }

      function initParticleEffect() {
          const canvas = document.getElementById('particle-effect-canvas');
          if (!canvas) { console.error("PARTICLES: #particle-effect-canvas NON TROVATO!"); return; }
          const ctx = canvas.getContext('2d');
          let particlesArray;
          function setCanvasSize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
          setCanvasSize();
          class Particle {
              constructor() { this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height; this.size = Math.random() * 2 + 0.5; this.speedX = (Math.random() * 0.8 - 0.4); this.speedY = (Math.random() * 0.8 - 0.4); this.baseOpacity = Math.random() * 0.4 + 0.2; this.opacity = this.baseOpacity; this.opacitySpeed = (Math.random() - 0.5) * 0.01; }
              update() { this.x += this.speedX; this.y += this.speedY; this.opacity += this.opacitySpeed; if (this.opacity > this.baseOpacity + 0.2 || this.opacity < this.baseOpacity - 0.2) { this.opacitySpeed *= -1; } if (this.opacity < 0) this.opacity = 0; if (this.opacity > 1) this.opacity = 1; if (this.x < -this.size) this.x = canvas.width + this.size; if (this.x > canvas.width + this.size) this.x = -this.size; if (this.y < -this.size) this.y = canvas.height + this.size; if (this.y > canvas.height + this.size) this.y = -this.size; }
              draw() { ctx.fillStyle = `rgba(255, 255, 230, ${this.opacity})`; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); }
          }
          function initParticles() { particlesArray = []; const numberOfParticles = Math.max(50, Math.floor((canvas.width * canvas.height) / 15000)); for (let i = 0; i < numberOfParticles; i++) { particlesArray.push(new Particle()); } }
          function animateParticles() { ctx.clearRect(0, 0, canvas.width, canvas.height); for (let i = 0; i < particlesArray.length; i++) { particlesArray[i].update(); particlesArray[i].draw(); } requestAnimationFrame(animateParticles); }
          initParticles(); animateParticles();
          let resizeTimeout; window.addEventListener('resize', () => { clearTimeout(resizeTimeout); resizeTimeout = setTimeout(() => { setCanvasSize(); initParticles(); }, 250); });
      }

      function initAudioPlayer() {
        const song = document.getElementById('indexPageSong');
        if (!song) { console.error("AUDIO: #indexPageSong non trovato."); return; }
        let hasInteracted = false; let interactionListeners = [];
        const tryPlayMusic = (eventSource) => { if (hasInteracted || (song.currentTime > 0 && !song.paused)) { removeInteractionListeners(); return; } hasInteracted = true; song.play().then(() => { removeInteractionListeners(); }).catch(e => { hasInteracted = false; }); };
        function addInteractionListener(target, eventType, handlerName) { const handler = () => tryPlayMusic(handlerName); target.addEventListener(eventType, handler, { once: true, passive: true }); interactionListeners.push({ target, eventType, handler }); }
        function removeInteractionListeners() { if (interactionListeners.length > 0) { interactionListeners.forEach(listener => { listener.target.removeEventListener(listener.eventType, listener.handler); }); interactionListeners = []; } }
        song.play().then(() => { hasInteracted = true; }).catch(() => { addInteractionListener(document.body, 'click', 'click'); addInteractionListener(window, 'scroll', 'scroll'); addInteractionListener(document.body, 'touchstart', 'touchstart'); addInteractionListener(window, 'keydown', 'keydown'); });
      }

      ready(() => {
        console.log("SCRIPT: DOM Caricato. Avvio funzioni principali.");
        if (typeof initDynamicBackground === 'function') initDynamicBackground();
        if (typeof initParticleEffect === 'function') initParticleEffect();
        if (typeof initAudioPlayer === 'function') initAudioPlayer();
        console.log("SCRIPT: Tutte le funzioni principali sono state chiamate.");
      });

      console.log("SCRIPT: Fine blocco script IIFE.");
    })(); // Chiusura e chiamata della IIFE
  </script>
</body>
</html>
